<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>libdap++: util_mit.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>util_mit.cc</h1><a href="util__mit_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">// -*- mode: c++; c-basic-offset:4 -*-</span>
00002 
00003 <span class="comment">// This file is part of libdap, A C++ implementation of the OPeNDAP Data</span>
00004 <span class="comment">// Access Protocol.</span>
00005 
00006 <span class="comment">// Copyright (c) 2002 OPeNDAP, Inc. </span>
00007 <span class="comment">// Author: James Gallagher &lt;jgallagher@opendap.org&gt;</span>
00008 <span class="comment">//</span>
00009 <span class="comment">// This library is free software; you can redistribute it and/or</span>
00010 <span class="comment">// modify it under the terms of the GNU Lesser General Public</span>
00011 <span class="comment">// License as published by the Free Software Foundation; either</span>
00012 <span class="comment">// version 2.1 of the License, or (at your option) any later version.</span>
00013 <span class="comment">// </span>
00014 <span class="comment">// This library is distributed in the hope that it will be useful,</span>
00015 <span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00016 <span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
00017 <span class="comment">// Lesser General Public License for more details.</span>
00018 <span class="comment">// </span>
00019 <span class="comment">// You should have received a copy of the GNU Lesser General Public</span>
00020 <span class="comment">// License along with this library; if not, write to the Free Software</span>
00021 <span class="comment">// Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00022 <span class="comment">//</span>
00023 <span class="comment">// You can contact OPeNDAP, Inc. at PO Box 112, Saunderstown, RI. 02874-0112</span>
00024  
00025 <span class="comment">// This file was derived from the libwww source code of 1998/08/20. The</span>
00026 <span class="comment">// copyright for the source of this derivative work can be found in the file</span>
00027 <span class="comment">// COPYRIGHT_W3C.</span>
00028 
00029                          
00030 <span class="preprocessor">#include "<a class="code" href="config__dap_8h.html">config_dap.h</a>"</span>
00031 
00032 <span class="keyword">static</span> <span class="keywordtype">char</span> rcsid[] <a class="code" href="config__dap_8h.html#a49">not_used</a> = {<span class="stringliteral">"$Id$"</span>};
00033 
00034 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00035 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00036 <span class="preprocessor">#include &lt;string&gt;</span>
00037 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
00038 <span class="preprocessor">#ifndef TM_IN_SYS_TIME</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#include &lt;time.h&gt;</span>
00040 <span class="preprocessor">#else</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00042 <span class="preprocessor">#endif</span>
00043 <span class="preprocessor"></span>
00044 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00045 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00046 
00047 <span class="preprocessor">#include &lt;iostream&gt;</span>
00048 <span class="preprocessor">#include &lt;<a class="code" href="util__mit_8h.html">util_mit.h</a>&gt;</span>
00049 
00050 <span class="keyword">using</span> std::cerr;
00051 <span class="keyword">using</span> std::endl;
00052 <span class="keyword">using</span> std::string;
00053 
00054 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">debug.h</a>"</span>
00055 
00056 <span class="keyword">static</span> <span class="keywordtype">char</span> * months[12] = {
00057     <span class="stringliteral">"Jan"</span>,<span class="stringliteral">"Feb"</span>,<span class="stringliteral">"Mar"</span>,<span class="stringliteral">"Apr"</span>,<span class="stringliteral">"May"</span>,<span class="stringliteral">"Jun"</span>,<span class="stringliteral">"Jul"</span>,<span class="stringliteral">"Aug"</span>,<span class="stringliteral">"Sep"</span>,<span class="stringliteral">"Oct"</span>,<span class="stringliteral">"Nov"</span>,<span class="stringliteral">"Dec"</span>
00058 };
00059 
00060 <span class="preprocessor">#ifndef HAVE_STRFTIME</span>
00061 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">char</span> * wkdays[7] = {
00062     <span class="stringliteral">"Sun"</span>,<span class="stringliteral">"Mon"</span>,<span class="stringliteral">"Tue"</span>,<span class="stringliteral">"Wed"</span>,<span class="stringliteral">"Thu"</span>,<span class="stringliteral">"Fri"</span>,<span class="stringliteral">"Sat"</span>
00063 };
00064 <span class="preprocessor">#endif</span>
00065 <span class="preprocessor"></span>
00066 <span class="comment">/* Upper- and Lowercase macros</span>
00067 <span class="comment"></span>
00068 <span class="comment">   The problem here is that toupper(x) is not defined officially unless</span>
00069 <span class="comment">   isupper(x) is. These macros are CERTAINLY needed on #if defined(pyr) ||</span>
00070 <span class="comment">   define(mips) or BDSI platforms. For safefy, we make them mandatory.</span>
00071 <span class="comment">*/</span>
00072 
00073 <span class="preprocessor">#ifndef TOLOWER</span>
<a name="l00074"></a><a class="code" href="util__mit_8cc.html#a0">00074</a> <span class="preprocessor"></span><span class="preprocessor">#define TOLOWER(c) tolower((int) (c))</span>
<a name="l00075"></a><a class="code" href="util__mit_8cc.html#a1">00075</a> <span class="preprocessor"></span><span class="preprocessor">#define TOUPPER(c) toupper((int) (c))</span>
00076 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00077 <span class="preprocessor"></span>
00078 <span class="keyword">static</span> <span class="keywordtype">int</span> 
00079 strncasecomp(<span class="keyword">const</span> <span class="keywordtype">char</span> *a, <span class="keyword">const</span> <span class="keywordtype">char</span> *b, <span class="keywordtype">int</span> n)
00080 {
00081     <span class="keyword">const</span> <span class="keywordtype">char</span> *p =a;
00082     <span class="keyword">const</span> <span class="keywordtype">char</span> *q =b;
00083     
00084     <span class="keywordflow">for</span>(p=a, q=b;; p++, q++) {
00085     <span class="keywordtype">int</span> diff;
00086     <span class="keywordflow">if</span> (p == a+n) <span class="keywordflow">return</span> 0; <span class="comment">/*   Match up to n characters */</span>
00087     <span class="keywordflow">if</span> (!(*p &amp;&amp; *q)) <span class="keywordflow">return</span> *p - *q;
00088     diff = <a class="code" href="util__mit_8cc.html#a0">TOLOWER</a>(*p) - <a class="code" href="util__mit_8cc.html#a0">TOLOWER</a>(*q);
00089     <span class="keywordflow">if</span> (diff) <span class="keywordflow">return</span> diff;
00090     }
00091     <span class="comment">/*NOTREACHED*/</span>
00092 }
00093 
00094 <span class="keyword">static</span> <span class="keywordtype">int</span> 
00095 make_month (<span class="keywordtype">char</span> * s, <span class="keywordtype">char</span> ** ends)
00096 {
00097     <span class="keywordtype">char</span> * ptr = s;
00098     <span class="keywordflow">while</span> (!isalpha((<span class="keywordtype">int</span>) *ptr)) ptr++;
00099     <span class="keywordflow">if</span> (*ptr) {
00100     <span class="keywordtype">int</span> i;
00101     *ends = ptr+3;      
00102     <span class="keywordflow">for</span> (i=0; i&lt;12; i++)
00103         <span class="keywordflow">if</span> (!strncasecomp(months[i], ptr, 3)) <span class="keywordflow">return</span> i;
00104     }
00105     <span class="keywordflow">return</span> 0;
00106 }
00107 
00122 time_t 
<a name="l00123"></a><a class="code" href="util__mit_8cc.html#a6">00123</a> <a class="code" href="util__mit_8cc.html#a6">parse_time</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * str, <span class="keywordtype">bool</span> expand)
00124 {
00125     <span class="keywordtype">char</span> * s;
00126     <span class="keyword">struct </span>tm tm;
00127     time_t t;
00128 
00129     <span class="keywordflow">if</span> (!str) <span class="keywordflow">return</span> 0;
00130 
00131     <span class="keywordflow">if</span> ((s = strchr(str, <span class="charliteral">','</span>))) {    <span class="comment">/* Thursday, 10-Jun-93 01:29:59 GMT */</span>
00132     s++;                <span class="comment">/* or: Thu, 10 Jan 1993 01:29:59 GMT */</span>
00133     <span class="keywordflow">while</span> (*s &amp;&amp; *s==<span class="charliteral">' '</span>) s++;
00134     <span class="keywordflow">if</span> (strchr(s,<span class="charliteral">'-'</span>)) {                     <span class="comment">/* First format */</span>
00135         <a class="code" href="debug_8h.html#a1">DBG</a>(cerr &lt;&lt; <span class="stringliteral">"Format...... Weekday, 00-Mon-00 00:00:00 GMT"</span> 
00136         &lt;&lt; endl);
00137         <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)strlen(s) &lt; 18) {
00138         <a class="code" href="debug_8h.html#a1">DBG</a>(cerr &lt;&lt; <span class="stringliteral">"ERROR....... Not a valid time format \""</span> 
00139             &lt;&lt; s &lt;&lt; <span class="stringliteral">"\""</span> &lt;&lt; endl);
00140         <span class="keywordflow">return</span> 0;
00141         }
00142         tm.tm_mday = strtol(s, &amp;s, 10);
00143         tm.tm_mon = make_month(s, &amp;s);
00144         tm.tm_year = strtol(++s, &amp;s, 10);
00145         tm.tm_hour = strtol(s, &amp;s, 10);
00146         tm.tm_min = strtol(++s, &amp;s, 10);
00147         tm.tm_sec = strtol(++s, &amp;s, 10);
00148 
00149     } <span class="keywordflow">else</span> {                        <span class="comment">/* Second format */</span>
00150         <a class="code" href="debug_8h.html#a1">DBG</a>(cerr &lt;&lt;<span class="stringliteral">"Format...... Wkd, 00 Mon 0000 00:00:00 GMT"</span> &lt;&lt; endl);
00151         <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)strlen(s) &lt; 20) {
00152         <a class="code" href="debug_8h.html#a1">DBG</a>(cerr &lt;&lt; <span class="stringliteral">"ERROR....... Not a valid time format \""</span>
00153             &lt;&lt; s &lt;&lt; <span class="stringliteral">"\""</span> &lt;&lt; endl);
00154         <span class="keywordflow">return</span> 0;
00155         }
00156         tm.tm_mday = strtol(s, &amp;s, 10);
00157         tm.tm_mon = make_month(s, &amp;s);
00158         tm.tm_year = strtol(s, &amp;s, 10) - 1900;
00159         tm.tm_hour = strtol(s, &amp;s, 10);
00160         tm.tm_min = strtol(++s, &amp;s, 10);
00161         tm.tm_sec = strtol(++s, &amp;s, 10);
00162     }
00163     } 
00164     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isdigit((<span class="keywordtype">int</span>) *str)) {
00165 
00166     <span class="keywordflow">if</span> (strchr(str, <span class="charliteral">'T'</span>)) { <span class="comment">/* ISO (limited format) date string */</span>
00167         <a class="code" href="debug_8h.html#a1">DBG</a>(cerr &lt;&lt; <span class="stringliteral">"Format...... YYYY.MM.DDThh:mmStzWkd"</span> &lt;&lt; endl);
00168         s = (<span class="keywordtype">char</span> *) str;
00169         <span class="keywordflow">while</span> (*s &amp;&amp; *s==<span class="charliteral">' '</span>) s++;
00170         <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)strlen(s) &lt; 21) {
00171         <a class="code" href="debug_8h.html#a1">DBG</a>(cerr &lt;&lt;<span class="stringliteral">"ERROR....... Not a valid time format \""</span>
00172             &lt;&lt; s &lt;&lt; <span class="stringliteral">"\""</span> &lt;&lt; endl);
00173         <span class="keywordflow">return</span> 0;
00174         }
00175         tm.tm_year = strtol(s, &amp;s, 10) - 1900;
00176         tm.tm_mon  = strtol(++s, &amp;s, 10);
00177         tm.tm_mday = strtol(++s, &amp;s, 10);
00178         tm.tm_hour = strtol(++s, &amp;s, 10);
00179         tm.tm_min  = strtol(++s, &amp;s, 10);
00180         tm.tm_sec  = strtol(++s, &amp;s, 10);
00181 
00182     } <span class="keywordflow">else</span> {                        <span class="comment">/* delta seconds */</span>
00183         t = expand ? time(NULL) + atol(str) : atol(str);
00184 
00185         <span class="keywordflow">return</span> t;
00186     }
00187 
00188     } <span class="keywordflow">else</span> {          <span class="comment">/* Try the other format:  Wed Jun  9 01:29:59 1993 GMT */</span>
00189     <a class="code" href="debug_8h.html#a1">DBG</a>(cerr &lt;&lt; <span class="stringliteral">"Format...... Wkd Mon 00 00:00:00 0000 GMT"</span> &lt;&lt; endl);
00190     s = (<span class="keywordtype">char</span> *) str;
00191     <span class="keywordflow">while</span> (*s &amp;&amp; *s==<span class="charliteral">' '</span>) s++;
00192     <a class="code" href="debug_8h.html#a1">DBG</a>(cerr &lt;&lt; <span class="stringliteral">"Trying...... The Wrong time format: "</span> &lt;&lt; s &lt;&lt; endl);
00193     <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)strlen(s) &lt; 24) {
00194         <a class="code" href="debug_8h.html#a1">DBG</a>(cerr &lt;&lt; <span class="stringliteral">"ERROR....... Not a valid time format \""</span>
00195         &lt;&lt; s &lt;&lt; <span class="stringliteral">"\""</span> &lt;&lt; endl);
00196         <span class="keywordflow">return</span> 0;
00197     }
00198     tm.tm_mon = make_month(s, &amp;s);
00199     tm.tm_mday = strtol(s, &amp;s, 10);
00200     tm.tm_hour = strtol(s, &amp;s, 10);
00201     tm.tm_min = strtol(++s, &amp;s, 10);
00202     tm.tm_sec = strtol(++s, &amp;s, 10);
00203     tm.tm_year = strtol(s, &amp;s, 10) - 1900;
00204     }
00205     <span class="keywordflow">if</span> (tm.tm_sec  &lt; 0  ||  tm.tm_sec  &gt; 59  ||
00206     tm.tm_min  &lt; 0  ||  tm.tm_min  &gt; 59  ||
00207     tm.tm_hour &lt; 0  ||  tm.tm_hour &gt; 23  ||
00208     tm.tm_mday &lt; 1  ||  tm.tm_mday &gt; 31  ||
00209     tm.tm_mon  &lt; 0  ||  tm.tm_mon  &gt; 11  ||
00210     tm.tm_year &lt;70  ||  tm.tm_year &gt;120) {
00211     <a class="code" href="debug_8h.html#a1">DBG</a>(cerr &lt;&lt; <span class="stringliteral">"ERROR....... Parsed illegal time"</span> &lt;&lt; endl);
00212     <span class="keywordflow">return</span> 0;
00213     }
00214 
00215     <span class="comment">/* Let mktime decide whether we have DST or not */</span>
00216     tm.tm_isdst = -1;
00217 
00218 <span class="preprocessor">#ifdef HAVE_TIMEGM</span>
00219 <span class="preprocessor"></span>
00220     t = timegm(&amp;tm);
00221 
00222 <span class="preprocessor">#else</span>
00223 <span class="preprocessor"></span>
00224 <span class="preprocessor">#ifdef HAVE_MKTIME</span>
00225 <span class="preprocessor"></span>
00226     <span class="comment">// Compute offset between localtime and GMT.</span>
00227     time_t offset;
00228     time_t now = time(0);
00229 <span class="preprocessor">#ifdef _REENTRANT</span>
00230 <span class="preprocessor"></span>    <span class="keyword">struct </span>tm gmt, local;
00231     offset = mktime(gmtime_r(&amp;now, &amp;gmt)) - mktime(localtime_r(&amp;now, &amp;local));
00232 <span class="preprocessor">#else</span>
00233 <span class="preprocessor"></span>    offset = mktime(gmtime(&amp;now)) - mktime(localtime(&amp;now));
00234 <span class="preprocessor">#endif</span>
00235 <span class="preprocessor"></span>
00236     t = mktime(&amp;tm) + offset;
00237 
00238 <span class="preprocessor">#else</span>
00239 <span class="preprocessor"></span>
00240 <span class="preprocessor">#error "Neither mktime nor timegm defined"</span>
00241 <span class="preprocessor"></span>
00242 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_TIMEGM */</span>
00243 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_MKTIME */</span>
00244 
00245     <a class="code" href="debug_8h.html#a1">DBG</a>(cerr &lt;&lt; <span class="stringliteral">"Time string. "</span> &lt;&lt; str &lt;&lt; <span class="stringliteral">" parsed to "</span> &lt;&lt; t 
00246     &lt;&lt; <span class="stringliteral">" calendar time or \""</span> &lt;&lt; ctime(&amp;t) &lt;&lt; <span class="stringliteral">"\" in local time"</span> &lt;&lt; endl);
00247 
00248     <span class="keywordflow">return</span> t;
00249 }
00250 
<a name="l00260"></a><a class="code" href="util__mit_8cc.html#a7">00260</a> string <a class="code" href="util__mit_8cc.html#a7">date_time_str</a>(time_t *calendar, <span class="keywordtype">bool</span> local)
00261 {
00262     <span class="keywordtype">char</span> buf[40];
00263 
00264 <span class="preprocessor">#ifdef HAVE_STRFTIME</span>
00265 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (local) {
00266     <span class="comment">/*</span>
00267 <span class="comment">    ** Solaris 2.3 has a bug so we _must_ use reentrant version</span>
00268 <span class="comment">    ** Thomas Maslen &lt;tmaslen@verity.com&gt;</span>
00269 <span class="comment">    */</span>
00270 <span class="preprocessor">#if defined(_REENTRANT) || defined(SOLARIS)</span>
00271 <span class="preprocessor"></span>    <span class="keyword">struct </span>tm loctime;
00272     localtime_r(calendar, &amp;loctime);
00273     strftime(buf, 40, <span class="stringliteral">"%a, %d %b %Y %H:%M:%S"</span>, &amp;loctime);
00274 <span class="preprocessor">#else</span>
00275 <span class="preprocessor"></span>    <span class="keyword">struct </span>tm *loctime = localtime(calendar);
00276     strftime(buf, 40, <span class="stringliteral">"%a, %d %b %Y %H:%M:%S"</span>, loctime);
00277 <span class="preprocessor">#endif </span><span class="comment">/* SOLARIS || _REENTRANT */</span>
00278     } <span class="keywordflow">else</span> {
00279 <span class="preprocessor">#if defined(_REENTRANT) || defined(SOLARIS)</span>
00280 <span class="preprocessor"></span>    <span class="keyword">struct </span>tm gmt;
00281     gmtime_r(calendar, &amp;gmt);
00282         strftime(buf, 40, <span class="stringliteral">"%a, %d %b %Y %H:%M:%S GMT"</span>, &amp;gmt);
00283 <span class="preprocessor">#else</span>
00284 <span class="preprocessor"></span>    <span class="keyword">struct </span>tm *gmt = gmtime(calendar);
00285         strftime(buf, 40, <span class="stringliteral">"%a, %d %b %Y %H:%M:%S GMT"</span>, gmt);
00286 <span class="preprocessor">#endif </span><span class="comment">/* SOLARIS || _REENTRANT */</span>
00287     }
00288 <span class="preprocessor">#else</span>
00289 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (local) {
00290 <span class="preprocessor">#if defined(_REENTRANT)</span>
00291 <span class="preprocessor"></span>    <span class="keyword">struct </span>tm loctime;
00292     localtime_r(calendar, &amp;loctime);
00293 <span class="preprocessor">#else</span>
00294 <span class="preprocessor"></span>    <span class="keyword">struct </span>tm *loctime = localtime(calendar);
00295 <span class="preprocessor">#endif </span><span class="comment">/* _REENTRANT */</span>
00296     sprintf(buf,<span class="stringliteral">"%s, %02d %s %04d %02d:%02d:%02d"</span>,
00297         wkdays[loctime-&gt;tm_wday],
00298         loctime-&gt;tm_mday,
00299         months[loctime-&gt;tm_mon],
00300         loctime-&gt;tm_year + 1900,
00301         loctime-&gt;tm_hour,
00302         loctime-&gt;tm_min,
00303         loctime-&gt;tm_sec);
00304     } <span class="keywordflow">else</span> {
00305 <span class="preprocessor">#if defined(_REENTRANT) || defined(SOLARIS)</span>
00306 <span class="preprocessor"></span>    <span class="keyword">struct </span>tm gmt;
00307     gmtime_r(calendar, &amp;gmt);
00308 <span class="preprocessor">#else</span>
00309 <span class="preprocessor"></span>    <span class="keyword">struct </span>tm *gmt = gmtime(calendar);
00310 <span class="preprocessor">#endif</span>
00311 <span class="preprocessor"></span>    sprintf(buf,<span class="stringliteral">"%s, %02d %s %04d %02d:%02d:%02d GMT"</span>,
00312         wkdays[gmt-&gt;tm_wday],
00313         gmt-&gt;tm_mday,
00314         months[gmt-&gt;tm_mon],
00315         gmt-&gt;tm_year + 1900,
00316         gmt-&gt;tm_hour,
00317         gmt-&gt;tm_min,
00318         gmt-&gt;tm_sec);
00319     }
00320 <span class="preprocessor">#endif</span>
00321 <span class="preprocessor"></span>    <span class="keywordflow">return</span> string(buf);
00322 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Feb 4 23:43:05 2004 for libdap++ by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
