<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>libdap++: AISResources.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>AISResources.cc</h1><a href="AISResources_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 <span class="comment">// -*- mode: c++; c-basic-offset:4 -*-</span>
00003 
00004 <span class="comment">// This file is part of libdap, A C++ implementation of the OPeNDAP Data</span>
00005 <span class="comment">// Access Protocol.</span>
00006 
00007 <span class="comment">// Copyright (c) 2003 OPeNDAP, Inc.</span>
00008 <span class="comment">// Author: James Gallagher &lt;jgallagher@opendap.org&gt;</span>
00009 <span class="comment">//</span>
00010 <span class="comment">// This library is free software; you can redistribute it and/or</span>
00011 <span class="comment">// modify it under the terms of the GNU Lesser General Public</span>
00012 <span class="comment">// License as published by the Free Software Foundation; either</span>
00013 <span class="comment">// version 2.1 of the License, or (at your option) any later version.</span>
00014 <span class="comment">// </span>
00015 <span class="comment">// This library is distributed in the hope that it will be useful,</span>
00016 <span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00017 <span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
00018 <span class="comment">// Lesser General Public License for more details.</span>
00019 <span class="comment">// </span>
00020 <span class="comment">// You should have received a copy of the GNU Lesser General Public</span>
00021 <span class="comment">// License along with this library; if not, write to the Free Software</span>
00022 <span class="comment">// Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00023 <span class="comment">//</span>
00024 <span class="comment">// You can contact OPeNDAP, Inc. at PO Box 112, Saunderstown, RI. 02874-0112.</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="config__dap_8h.html">config_dap.h</a>"</span>
00027 
00028 <span class="preprocessor">#include &lt;iostream&gt;</span>
00029 <span class="preprocessor">#include &lt;fstream&gt;</span>
00030 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00031 <span class="preprocessor">#include &lt;functional&gt;</span>
00032 
00033 <span class="preprocessor">#include "<a class="code" href="AISResources_8h.html">AISResources.h</a>"</span>
00034 <span class="preprocessor">#include "<a class="code" href="AISDatabaseParser_8h.html">AISDatabaseParser.h</a>"</span>
00035 
00036 <span class="keyword">using</span> std::ostream ;
00037 <span class="keyword">using</span> std::ofstream ;
00038 <span class="keyword">using</span> std::endl ;
00039 
00040 <span class="preprocessor">#ifdef WIN32  //  Gives us find_if</span>
00041 <span class="preprocessor"></span><span class="keyword">using</span> <span class="keyword">namespace </span>std;
00042 <span class="preprocessor">#endif</span>
00043 <span class="preprocessor"></span>
00044 
00048 ostream &amp;
<a name="l00049"></a><a class="code" href="AISResources_8cc.html#a0">00049</a> <a class="code" href="AISResources_8cc.html#a1">operator&lt;&lt;</a>(ostream &amp;os, <span class="keyword">const</span> <a class="code" href="classResource.html">Resource</a> &amp;r)
00050 {
00051     os &lt;&lt; <span class="stringliteral">"&lt;ancillary"</span>;
00052     <span class="keywordflow">if</span> (r.<a class="code" href="classResource.html#Resourcer1">d_rule</a> != <a class="code" href="classResource.html#Resourcew3Resourcew0">Resource::overwrite</a>) {
00053     os &lt;&lt; <span class="stringliteral">" rule=\""</span>;
00054     (r.<a class="code" href="classResource.html#Resourcer1">d_rule</a> == <a class="code" href="classResource.html#Resourcew3Resourcew2">Resource::fallback</a>) ? os &lt;&lt; <span class="stringliteral">"fallback\""</span>: os &lt;&lt; <span class="stringliteral">"replace\""</span>;
00055     }
00056     os &lt;&lt; <span class="stringliteral">" url=\""</span> &lt;&lt; r.<a class="code" href="classResource.html#Resourcer0">d_url</a> &lt;&lt; <span class="stringliteral">"\"/&gt;"</span>;
00057 
00058     <span class="keywordflow">return</span> os;
00059 }
00060 
00064 ostream &amp;
<a name="l00065"></a><a class="code" href="AISResources_8cc.html#a1">00065</a> <a class="code" href="AISResources_8cc.html#a1">operator&lt;&lt;</a>(ostream &amp;os, <span class="keyword">const</span> <a class="code" href="classAISResources.html">AISResources</a> &amp;ais_res)
00066 {
00067     os &lt;&lt; <span class="stringliteral">"&lt;?xml version=\"1.0\" encoding=\"US-ASCII\" standalone=\"yes\"?&gt;"</span>
00068        &lt;&lt; endl;
00069     os &lt;&lt; <span class="stringliteral">"&lt;!DOCTYPE ais SYSTEM \"http://www.opendap.org/ais/ais_database.dtd\"&gt;"</span> &lt;&lt; endl;
00070     os &lt;&lt; <span class="stringliteral">"&lt;ais xmlns=\"http://xml.opendap.org/ais\"&gt;"</span> &lt;&lt; endl;
00071 
00072     <span class="keywordflow">for</span> (AISResources::ResourceRegexpsCIter pos = ais_res.<a class="code" href="classAISResources.html#AISResourcesr1">d_re</a>.begin(); 
00073     pos != ais_res.<a class="code" href="classAISResources.html#AISResourcesr1">d_re</a>.end(); ++pos) {
00074     os &lt;&lt; <span class="stringliteral">"&lt;entry&gt;"</span> &lt;&lt; endl;
00075     <span class="comment">// write primary</span>
00076     os &lt;&lt; <span class="stringliteral">"&lt;primary regexp=\""</span> &lt;&lt; pos-&gt;first &lt;&lt; <span class="stringliteral">"\"/&gt;"</span> &lt;&lt; endl;
00077     <span class="comment">// write the vector of Resource objects</span>
00078     <span class="keywordflow">for</span> (<a class="code" href="AISResources_8h.html#a2">ResourceVectorCIter</a> i = pos-&gt;second.begin(); 
00079          i != pos-&gt;second.end(); ++i) {
00080         os &lt;&lt; *i &lt;&lt; endl;
00081     }
00082     os &lt;&lt; <span class="stringliteral">"&lt;/entry&gt;"</span> &lt;&lt; endl;
00083     }
00084 
00085     <span class="comment">//  Under VC++ 6.x, 'pos' is twice tagged as twice in the</span>
00086     <span class="comment">//  same scope (this method - not just within for blocks), so</span>
00087     <span class="comment">//  I gave it another name.  ROM - 6/14/03</span>
00088 <span class="preprocessor">#ifdef WIN32</span>
00089 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (AISResources::ResourceMapCIter pos2 = ais_res.<a class="code" href="classAISResources.html#AISResourcesr0">d_db</a>.begin();
00090      pos2 != ais_res.<a class="code" href="classAISResources.html#AISResourcesr0">d_db</a>.end(); ++pos2) {
00091     os &lt;&lt; <span class="stringliteral">"&lt;entry&gt;"</span> &lt;&lt; endl;
00092     <span class="comment">// write primary</span>
00093     os &lt;&lt; <span class="stringliteral">"&lt;primary url=\""</span> &lt;&lt; pos2-&gt;first &lt;&lt; <span class="stringliteral">"\"/&gt;"</span> &lt;&lt; endl;
00094     <span class="comment">// write the vector of Resource objects</span>
00095     <span class="keywordflow">for</span> (<a class="code" href="AISResources_8h.html#a2">ResourceVectorCIter</a> i = pos2-&gt;second.begin(); 
00096          i != pos2-&gt;second.end(); ++i) {
00097         os &lt;&lt; *i &lt;&lt; endl;
00098     }
00099     os &lt;&lt; <span class="stringliteral">"&lt;/entry&gt;"</span> &lt;&lt; endl;
00100     }
00101 <span class="preprocessor">#else</span>
00102 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (AISResources::ResourceMapCIter pos = ais_res.<a class="code" href="classAISResources.html#AISResourcesr0">d_db</a>.begin();
00103      pos != ais_res.<a class="code" href="classAISResources.html#AISResourcesr0">d_db</a>.end(); ++pos) {
00104     os &lt;&lt; <span class="stringliteral">"&lt;entry&gt;"</span> &lt;&lt; endl;
00105     <span class="comment">// write primary</span>
00106     os &lt;&lt; <span class="stringliteral">"&lt;primary url=\""</span> &lt;&lt; pos-&gt;first &lt;&lt; <span class="stringliteral">"\"/&gt;"</span> &lt;&lt; endl;
00107     <span class="comment">// write the vector of Resource objects</span>
00108     <span class="keywordflow">for</span> (<a class="code" href="AISResources_8h.html#a2">ResourceVectorCIter</a> i = pos-&gt;second.begin(); 
00109          i != pos-&gt;second.end(); ++i) {
00110         os &lt;&lt; *i &lt;&lt; endl;
00111     }
00112     os &lt;&lt; <span class="stringliteral">"&lt;/entry&gt;"</span> &lt;&lt; endl;
00113     }
00114 <span class="preprocessor">#endif</span>
00115 <span class="preprocessor"></span>
00116     os &lt;&lt; <span class="stringliteral">"&lt;/ais&gt;"</span> &lt;&lt; endl;
00117 
00118     <span class="keywordflow">return</span> os;
00119 }
00120 
<a name="l00123"></a><a class="code" href="classAISResources.html#AISResourcesa1">00123</a> <a class="code" href="classAISResources.html#AISResourcesa0">AISResources::AISResources</a>(<span class="keyword">const</span> string &amp;database) <span class="keywordflow">throw</span>(<a class="code" href="classAISDatabaseReadFailed.html">AISDatabaseReadFailed</a>)
00124 {
00125     read_database(database);
00126 }
00127 
00132 <span class="keywordtype">void</span> 
<a name="l00133"></a><a class="code" href="classAISResources.html#AISResourcesa3">00133</a> <a class="code" href="classAISResources.html#AISResourcesa3">AISResources::add_url_resource</a>(<span class="keyword">const</span> string &amp;url, <span class="keyword">const</span> <a class="code" href="classResource.html">Resource</a> &amp;ancillary)
00134 {
00135     <a class="code" href="classAISResources.html#AISResourcesa3">add_url_resource</a>(url, <a class="code" href="AISResources_8h.html#a0">ResourceVector</a>(1, ancillary));
00136 }
00137 
00143 <span class="keywordtype">void</span> 
<a name="l00144"></a><a class="code" href="classAISResources.html#AISResourcesa4">00144</a> <a class="code" href="classAISResources.html#AISResourcesa3">AISResources::add_url_resource</a>(<span class="keyword">const</span> string &amp;url, <span class="keyword">const</span> <a class="code" href="AISResources_8h.html#a0">ResourceVector</a> &amp;rv)
00145 {
00146     ResourceMapIter pos = d_db.find(url);
00147     <span class="keywordflow">if</span> (pos == d_db.end()) {
00148     d_db.insert(std::make_pair(url, rv));
00149     }
00150     <span class="keywordflow">else</span> {
00151     <span class="comment">// There's already a ResourceVector, append to it.</span>
00152     <span class="keywordflow">for</span> (<a class="code" href="AISResources_8h.html#a2">ResourceVectorCIter</a> i = rv.begin(); i != rv.end(); ++i)
00153         pos-&gt;second.push_back(*i);
00154     }
00155 }
00156 
00161 <span class="keywordtype">void</span> 
<a name="l00162"></a><a class="code" href="classAISResources.html#AISResourcesa5">00162</a> <a class="code" href="classAISResources.html#AISResourcesa5">AISResources::add_regexp_resource</a>(<span class="keyword">const</span> string &amp;re, <span class="keyword">const</span> <a class="code" href="classResource.html">Resource</a> &amp;ancillary)
00163 {
00164     <a class="code" href="classAISResources.html#AISResourcesa5">add_regexp_resource</a>(re, <a class="code" href="AISResources_8h.html#a0">ResourceVector</a>(1, ancillary));
00165 }
00166 
00173 <span class="keywordtype">void</span> 
<a name="l00174"></a><a class="code" href="classAISResources.html#AISResourcesa6">00174</a> <a class="code" href="classAISResources.html#AISResourcesa5">AISResources::add_regexp_resource</a>(<span class="keyword">const</span> string &amp;re, <span class="keyword">const</span> <a class="code" href="AISResources_8h.html#a0">ResourceVector</a> &amp;rv)
00175 {
00176     ResourceRegexpsIter pos = find_if(d_re.begin(), d_re.end(), 
00177                       FindRegexp(re));
00178     <span class="keywordflow">if</span> (pos == d_re.end()) {
00179     d_re.push_back(std::make_pair(re, rv));
00180     }
00181     <span class="keywordflow">else</span> {
00182     <span class="comment">// There's already a ResourceVector, append to it.</span>
00183     <span class="keywordflow">for</span> (<a class="code" href="AISResources_8h.html#a2">ResourceVectorCIter</a> i = rv.begin(); i != rv.end(); ++i)
00184         pos-&gt;second.push_back(*i);
00185     }
00186 }
00187 
00193 <span class="keywordtype">bool</span> 
<a name="l00194"></a><a class="code" href="classAISResources.html#AISResourcesa7">00194</a> <a class="code" href="classAISResources.html#AISResourcesa7">AISResources::has_resource</a>(<span class="keyword">const</span> string &amp;primary)<span class="keyword"> const</span>
00195 <span class="keyword"></span>{
00196     <span class="keywordflow">return</span> ((d_db.find(primary) != d_db.end())
00197         || (find_if(d_re.begin(), d_re.end(), MatchRegexp(primary)) 
00198         != d_re.end()));
00199 
00200 }
00201 
00215 <a class="code" href="AISResources_8h.html#a0">ResourceVector</a>
<a name="l00216"></a><a class="code" href="classAISResources.html#AISResourcesa8">00216</a> <a class="code" href="classAISResources.html#AISResourcesa8">AISResources::get_resource</a>(<span class="keyword">const</span> string &amp;primary)
00217     <span class="keywordflow">throw</span>(<a class="code" href="classNoSuchPrimaryResource.html">NoSuchPrimaryResource</a>)
00218 {
00219     <a class="code" href="AISResources_8h.html#a0">ResourceVector</a> rv;
00220     <span class="keyword">const</span> ResourceMapIter &amp;i = d_db.find(primary);
00221 
00222     <span class="keywordflow">if</span> (i != d_db.end())
00223     rv = i-&gt;second;
00224 
00225     <span class="keyword">const</span> ResourceRegexpsIter &amp;j = find_if(d_re.begin(), d_re.end(),
00226                        MatchRegexp(primary));
00227     <span class="keywordflow">if</span> (j != d_re.end())
00228     copy(j-&gt;second.begin(), j-&gt;second.end(), inserter(rv, rv.begin()));
00229 
00230     <span class="keywordflow">if</span> (rv.size() == 0)
00231     <span class="keywordflow">throw</span> <a class="code" href="classNoSuchPrimaryResource.html">NoSuchPrimaryResource</a>();
00232 
00233     <span class="keywordflow">return</span> rv;  
00234 }
00235 
00240 <span class="keywordtype">void</span> 
<a name="l00241"></a><a class="code" href="classAISResources.html#AISResourcesa9">00241</a> <a class="code" href="classAISResources.html#AISResourcesa9">AISResources::read_database</a>(<span class="keyword">const</span> string &amp;database) 
00242     <span class="keywordflow">throw</span>(<a class="code" href="classAISDatabaseReadFailed.html">AISDatabaseReadFailed</a>)
00243 {
00244     <a class="code" href="classAISDatabaseParser.html">AISDatabaseParser</a> parser;
00245 
00246     parser.<a class="code" href="classAISDatabaseParser.html#AISDatabaseParsera0">intern</a>(database, <span class="keyword">this</span>);
00247 }
00248 
00256 <span class="keywordtype">void</span> 
<a name="l00257"></a><a class="code" href="classAISResources.html#AISResourcesa10">00257</a> <a class="code" href="classAISResources.html#AISResourcesa10">AISResources::write_database</a>(<span class="keyword">const</span> string &amp;filename)
00258     <span class="keywordflow">throw</span>(<a class="code" href="classAISDatabaseWriteFailed.html">AISDatabaseWriteFailed</a>)
00259 {
00260     ofstream fos;
00261     fos.open(filename.c_str());
00262 
00263     <span class="keywordflow">if</span> (!fos)
00264     <span class="keywordflow">throw</span> <a class="code" href="classAISDatabaseWriteFailed.html">AISDatabaseWriteFailed</a>(<span class="stringliteral">"Could not open file :"</span> + filename);
00265 
00266     fos &lt;&lt; *<span class="keyword">this</span> &lt;&lt; endl;
00267     
00268     <span class="keywordflow">if</span> (!fos)
00269     <span class="keywordflow">throw</span> <a class="code" href="classAISDatabaseWriteFailed.html">AISDatabaseWriteFailed</a>();
00270 }
00271 
00272 <span class="comment">// $Log: AISResources_8cc-source.html,v $
00272 <span class="comment">// Revision 1.4  2004/02/05 06:51:15  jimg
00272 <span class="comment">// Added/update.
00272 <span class="comment">//</span>
00273 <span class="comment">// Revision 1.7.2.2  2003/09/06 22:17:38  jimg</span>
00274 <span class="comment">// Updated the documentation.</span>
00275 <span class="comment">//</span>
00276 <span class="comment">// Revision 1.7.2.1  2003/06/15 06:54:31  rmorris</span>
00277 <span class="comment">// Initial port regarding AIS* to win32.</span>
00278 <span class="comment">//</span>
00279 <span class="comment">// Revision 1.7  2003/03/12 01:07:34  jimg</span>
00280 <span class="comment">// Added regular expressions to the AIS subsystem. In an AIS database (XML)</span>
00281 <span class="comment">// it is now possible to list a regular expression in place of an explicit</span>
00282 <span class="comment">// URL. The AIS will try to match this Regexp against candidate URLs and</span>
00283 <span class="comment">// return the ancillary resources for all those that succeed.</span>
00284 <span class="comment">//</span>
00285 <span class="comment">// Revision 1.6  2003/02/27 22:21:01  pwest</span>
00286 <span class="comment">// Removed ResourceRule, moving enum ResourceRule to Resource.h, renaming it to</span>
00287 <span class="comment">// rule</span>
00288 <span class="comment">//</span>
00289 <span class="comment">// Revision 1.5  2003/02/26 06:56:11  jimg</span>
00290 <span class="comment">// Made has_resource const.</span>
00291 <span class="comment">//</span>
00292 <span class="comment">// Revision 1.4  2003/02/26 06:35:48  jimg</span>
00293 <span class="comment">// Added iostream header. Moved the file open out of the constructor; this</span>
00294 <span class="comment">// seemed to be throwing an exception when the file did not exist, even though</span>
00295 <span class="comment">// that makes no sense...</span>
00296 <span class="comment">//</span>
00297 <span class="comment">// Revision 1.3  2003/02/26 01:27:04  jimg</span>
00298 <span class="comment">// Fixed call to AISDatabaseParser::intern (changed the name from parse).</span>
00299 <span class="comment">//</span>
00300 <span class="comment">// Revision 1.2  2003/02/26 00:39:39  jimg</span>
00301 <span class="comment">// Changed name of is_resource to has_resource.</span>
00302 <span class="comment">//</span>
00303 <span class="comment">// Revision 1.1  2003/02/20 22:15:01  jimg</span>
00304 <span class="comment">// Added.</span>
00305 <span class="comment">//</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Feb 4 23:42:54 2004 for libdap++ by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
