
% This file contains documentation on the design of the HTML interface to
% DODS originally developed by George Milkowski and subsequently hacked by Qi
% Zhang and James Gallagher. In mid 1998 James Gallagher added the dataset
% registry and multi-file capabilities.
%
% Note that one of the figures may look hosed with xdvi but still prints
% correctly on a PS printer.
%
% $Id$
%

\documentclass{article}
\usepackage{rotating,subfigure,vcode,html,psfig}
\psfigurepath{html-interface-figs}
\input{../../boiler/html-refs}

\begin{document}

\title{Design of the DODS HTML Interface} 

\author{James Gallagher\thanks{George Milkowski wrote the original version of
    this interface and Qi Zhang made various improvements to the software.
    The version described here is a rewrite of the original Perl software
    using \Cpp\ and adds the directory browser interface (which is written in
    Perl).}}

\date{\today}

\maketitle

\begin{htmlonly}
\pslink{http://dcz.dods.org/html-interface.ps}
\end{htmlonly}

\begin{abstract}
  
  An HTML interface for DODS was written in 1997 and demonstrated at the
  Seattle TOS meeting.  The intent was to build an interface that would work
  for all possible DODS datasets and not require any information beyond what
  every dataset must provide (a valid DDS and an empty DAS). In addition, the
  interface was designed to display extra information, if present, in a
  sensible way. 
  
  The interface was implemented as a CGI which generates an HTML form
  customized to a particular DODS dataset. The form provides a way for users
  to enter queries for each variable in the dataset (an entry box is provided
  for each variable). Because the form is `live' users can see how the
  entries they make in the text edit boxes affect the DODS URL, particularly
  the constraint expression. To do this the CGI generates both HTML and
  JavaScript code. Thus the client software used to display the interface is
  any JavaScript-aware web browser.

  In addition to the HTML display of single datasets, a directory feature was
  added which provides a way, albeit primitive, for users to navigate
  multi-file datasets. Unlike other schemes we are working on, the `directory
  listing' approach employed does not hide the underlying organization of the
  files or datasets from the user.

\end{abstract}

\tableofcontents

\pagebreak

\section{Introduction}

This document describes the organization of an HTML interface to DODS. It is
not a user's guide!

The software may be found in the DODS project under the {\tt
  src/tools/www\-interface} directory. 

The HTML interface to DODS provides a way for users to read data from DODS
datasets using only a WWW browser.  The browser is used to display HTML which
is built on-the-fly by the DODS server\footnote{AS of version 3.1 of DODS,
  the servers have this as builtin a feature. Older servers can be accessed
  using the HTML form interface through an intermediary computer described
  later in this paper.}. While this interface is not the most powerful one
imaginable---only limited functionality is available on the client-side.
However, \emph{any} DODS dataset may be accessed with this tool.

\section{Overall Organization}

The HTML generated by the DODS server is different for single- or multi-file
datasets. For single-file datasets, the HTML is a form which provides a
simple way to enter queries which may be submitted to DODS datasets and it is
also an easy way to learn how to write the sometimes daunting DODS URLs. The
query form is `live' in that it automatically updates the data URL with new
constraints as the user enters them for each variable.  For multi-file
datasets, the HTML is a directory listing similar to the listings returned by
web servers. However, once the user navigates to a single file, the HTML form
used for the single-file datasets is displayed.

\begin{quote}
  We actually have two ways to access multi-file datasets. One is the
  \emph{file server} and the other is the interface described in this paper
  (in email on the dods-core list we've called this the \emph{dods-dir}
  interface). Both should be supported by the project since they server
  different needs. The directory interface described here is useful for web
  crawlers because they can use it to traverse file hierarchies; the
  \emph{file server} is more suited to our plans to build servers which
  automatically aggregate multi-file datasets into a \emph{virtual dataset}.
\end{quote}

The process that builds the HTML form is described in
Section~\ref{sec:build}. The form is built using the DDS and DAS as read from
the dataset itself. It is then sent back to the user's web browser and
displayed. The user builds up a query and disposes of the query by requesting
either ASCII data, Binary data or data import to Matlab. The form provides a
button for each disposition.

\begin{quote}
  If these data are to be imported to Matlab then the user must have Matlab,
  the DODS client program {\tt loaddods} and the DODS WWW helper program {\tt
    urlqueue}.  installed on their machine. In addition, their web browser
  (the one used to display the HTML form) must be configured to route DODS
  MIME documents to the {\tt urlqueue} helper program. See the DODS User's
  guide for information about the programs. This is really a detail of the
  loaddods program.
\end{quote}

Multi-file datasets are handled differently. Since they are collections of
files and generally spread across several directories where the directory
structure contains some (implicit) organizational information, the interface
provides a directory navigation function in addition to the query form. The
navigation function uses the directory listing pages generated by web
servers. Thus, rather than installing software on the target machines, the
WWW interface's directory navigation feature requires no changes/additions to
the existing DODS servers. See Section~\ref{sec:multifile}.

Figure~\ref{fig:overall} shows the organization of the HTML interface. The
`Page of dataset URLs' data store is currently written in HTML and is not
actually part of the HTML form interface; it is a starting point for users
and is included just to round out the diagram. It is also possible to access
the HTML form interface by typing the URL into a web browser.

\subsection{Version 3.1 servers versus older servers}

The version 3.1 DODS servers support both the HTML form and
the directory browsing interfaces. The HTML form is accessed by appending the
suffix {\tt .html} to a DODS URL. The directory browsing interface is
accessed by referencing a directory through a DODS server (and ending the
DODS URL in a slash)\footnote{Or a backslash for servers running on Windows
  NT, when we support that.}. 

Older servers do not include support for these two features. However, it is
still possible to use these interfaces with those datasets. The HTML form
interface can be wrapped in a CGI which acts as an intermediary between the
user's web browser and the dataset's server. This CGI must receive the target
dataset URL as a parameter. It then access the dataset, reads the DAS and DDS
and returns to the user the HTML form. The form will build a URL which
retrieves data from the dataset. The intermediary is used only to initially
build the HTML form.

To access the directory browsing interface for datasets served by older
servers, and intermediary CGI can also be used. In this case the server's
base URL (the URL up to the DODS server's name but no further), the dataset's
URL (not its DODS URL) and the file extension used to recognize which files
should have their listings transformed into DODS URLs. This intermediary is
more complex than the HTML form intermediary and might not be implemented
and/or fully deployed.

\begin{figure}
\centerline{\psfig{figure=general-DFD.ps,height=7in}}
\caption{A Data Flow Diagram for the HTML Form Interface.}
\label{fig:overall}
\end{figure}

\section{Building the HTML Form}
\label{sec:build}

Figure~\ref{fig:build} shows the organization of the `Build HTML Form'
function.  This function uses the dataset URL to get and parse the DAS and
DDS objects. Following the DAS and DDS parse steps, the HTML form is
generated. The form is generated in two steps. First a header section
(enclosed in an HTML $<$head$>$ $<$/head$>$ element) with some JavaScript 1.1
code is built. This code is customized to the dataset using information
parsed from the DAS and DDS objects. See the source file {\tt
  javascript.h.tmpl and JavaScript.h}.

The body of the HTML document is a form which is, like the JavaScript code in
the header, customized to the particular dataset. This code is generated by
the software in {\tt www\_int.cc} and the overloaded {\tt print\_val()}
method of the class files WWW$<type name>$.

JavaScript code is included in the form so that the it can build up the
complex (as perceived by many users) URL syntax from simpler `fill in the
box' form elements. The form is `live' in the sense that user's actions are
immediately propagated from the entry elements to the URL itself. This makes
the interface a tool that simplifies learning how to write URLs by hand. 

Figure~\ref{fig:screen} shows what the HTML form looks like for a simple
dataset. 

\begin{figure}
\centerline{\psfig{figure=build-form.ps,height=7in}}
\caption{A Data Flow Diagram for the Build Query Form function.}
\label{fig:build}
\end{figure}

\begin{figure}
\centerline{\psfig{figure=html-form2.ps,width=5in}}
\caption{Screen shot of the HTML form for a simple dataset.}
\label{fig:screen}
\end{figure}

\section{Multi-File Datasets}
\label{sec:multifile}

The WWW interface must be able to work with multi-file datasets. There are
many datasets in DODS that are comprised of large sets of files. While the
\emph{file servers}\footnote{Described elsewhere.} also provide a way to
reference parts of multi-file datasets, this component of the DODS server
makes it simple for web-based tools (browsers, robots, etc.) to look at this
class of dataset.

Web servers provide a simple way to browse directories under their {\em
  htdocs}\footnote{In this section I'm assuming that the characteristics of
  the NCSA/Apache server are fairly universal, rather than say ``\ldots for
  the NCSA/apache server \ldots'' over an over.} directory by generating a
page of HTML which contains links to every file and/or directory within a
directory and a back link to that directory's parent. The WWW interface
handles multi-file datasets by filtering this HTML directory from a web
server listing and replacing the links to data files with links to the HTML
form interface.

In order to filter the HTML directory listing, a second function was added to
the DODS servers. This is called the \emph{directory browser}. It takes the URL
to the {\em data tree},\footnote{The root of the multi-file dataset.} the URL
of the server to use with that dataset and a regular expression which can
identify data files in this dataset. The CGI retrieves the HTML directory
listing for the given directory at the root of the data tree. It then filters
that page as follows:

\begin{itemize}
  
\item replace the URLs for any subdirectories it contains with calls to the
  filter CGI (adjusting the data tree parameter and necessary).
  
\item replace the URLs for data files with calls to the \emph{directory
    browser} interface.

\item performing some miscellaneous cosmetic changes.

\end{itemize}

Figure~\ref{fig:beforeafter} shows a short page before and after filtering.
The directory browser interface extracts the data url (relative to the host
web servers \emph{htdocs} directory and the base DODS server url (which
includes the http protocol signifier, machine name, CGI directory and DODS
server name). The extension used to recognize files that are to be treated as
data files (and whose links should be transformed into links that reference
the DODS server's HTML form interface) is hardcoded into the directory
browser via a constant in the DODS server software.

\begin{description}

\item [data url] {\tt http://dcz.dods.org/data/}
\item [server url] {\tt http://dcz.dods.org/test-3.1/nph-hdf/}
\item [extension] {\tt \verb+.*\.hdf+}

\end{description}

These figures show how the directory names are processed (look at the {\tt
  back} link) as well as data file (look at the {\tt 1990104h09da-gdm.hdf}
link). Note that since the {\tt ext} regular expression only specifies files
named {\tt *.hdf}, the files named {\tt *.HDF}, {\tt *.gz}, \dots, are not
recognized. Getting {\tt ext} correct is important. Equally important is having
{\tt ext} since it prevents {\tt README} and other files from being passed to
the HTML form function and ensures that they behave as users expect.

\begin{sidewaysfigure}
\begin{scriptsize}
\subfigure[Before Modification]{\input{html-interface-figs/dir-before}}
\subfigure[After Modification]{\input{html-interface-figs/dir-after}}
\end{scriptsize}
\caption{The HTML Directory Listing from an Apache WWW Server Before and
  After Processing by  the directory browser function.}
\label{fig:beforeafter}
\end{sidewaysfigure}

\end{document}
