%
% $Id$
%
% Documentation for the DAP 2. To be submitted to NASA/ESE SPG.
%

\documentclass[justify]{nasa-ese}
\usepackage{acronym}

\rcsInfo $Id$

\input{../dap_boiler}

\renewcommand{\Tableref}[2][here]{\texorhtml{Table~\ref{#2}}{\link{#1}{#2}}}
\renewcommand{\Figureref}[2][here]{\texorhtml{Figure~\ref{#2}}{\link{#1}{#2}}}
\renewcommand{\new}[1]{\emph{#1}}

\title{The Data Access Protocol --- DAP 2.0}
\htmltitle{The Data Access Protocol --- DAP 2.0}
\author{James Gallagher, Nathan Potter, Tom Sgouros, Steve Hankin, Glenn Flierl}
\date{\rcsInfoDate \\ Revision: \rcsInfoRevision}
\htmladdress{James Gallagher <jgallagher@opendap.org>, \rcsInfoDate, 
  Revision: \rcsInfoRevision}
\htmldirectory{html}
\htmlname{dap2.0}

\eseRfcnumber{004.0.08}
\eseCategory{Draft Community Standard}
\eseUpdates{None}
\eseAuthor{Gallagher, Potter, Sgouros, Hankin, Flierl}
\eseTitle{DAP 2.0 Standard}
\eseDate{\rcsInfoDate}
\eseStatus{This is a description of a Draft ESE Community Standard}
\eseDistribution{Distribution of this Draft ESE Community Standard is
  unlimited.}

\eseChange{004.0.08, 27 October 2005, Added a note that the type names
  are case-insensitive on page~\ref{sec-atomic-int}; Clarified the
  typical use of XDR so that it's clear that the number of elements of
  an array is sent twice in the case of an array of atomic types
  (Byte, ..., Float64) but only once in the case of the remaining
  types (see page~\ref{par:array}); An error in the grammar for
  Sequences which was discovered previously was left out of a previous
  revision. Sequences are limited to at most a single inner Sequence
  `per level.' See page~\ref{sequence-grammar}.\\
  004.0.07, 3 May 2005, Corrected the description of the \lit{Host}
  header in Section~\ref{sec-host}. The header was incorrectly
  described as containing the DNS name or IP address of the client. In
  fact (and in conformance with HTTP/1.1) it contains the name/number of the
  \emph{server}.\\
  004.0.06, 12 April 2005, Changed designation from
  `Proposed\ldots' to `Draft Community Standard;' Added a
  clarification of `stride' in a hyperslab
  (Section~\ref{sec-ce-projections}); Corrected the grammar for
  \Attributes to indicate that they may have both scalar and vector
  values (Section~\ref{sec-das}); Added a description of Conditional
  Requests (Section~\ref{sec:conditional-requests}); Added a
  description of the encoding of empty Sequence responses
  (Paragraph~\ref{par:sequence}); Added addresses for all authors.\\
  004.0.05, 17 Jan 2005, Added a note about the Expires header to the
  section on HTTP/1.1 caching (Section~\ref{sec-http-caching}); Added
  note about XDR encoding of the Start of Instance and End of
  Sequence markers (Paragraph~\ref{par:sequence}).\\
  004.0.04, 20 Dec. 2004, Corrected the descriptions of the \Array,
  \Grid and \Sequence types so that all use zero-based indexing and so
  that all explanatory and example text is consistent with row-major
  ordering of data (Sections~\ref{sec-constructor-grid},
  \ref{sec-constructor-sequence}, and \ref{sec-ce-projections});
  Corrected the description of the relational operators in the
  selection part of the constraint expression
  (Table~\ref{tab-ce-relations} on page~\pageref{tab-ce-relations});
  Added information on supporting HTTP/1.1 caching
  (Section~\ref{sec-http-caching}); Added information on the encoding
  of byte arrays (Paragraph~\ref{par:array})\\
  004.0.03, 13 Sept. 2004, Editorial changes; Added a clarification of
  the terms `persistent representation' and `on-the-wire' to ``Data
  Representation'' (Section~\ref{sec:data-representation}); Added this
  ``Change Explanation'' section for conformance with ESE RFC 003 and
  made entries for the two previous versions using information from
  CVS; Adopted the new RFC version numbering system and set the number
  of this document at 004.0.03.\\
  004.0.02, 6 Aug. 2004, Editorial changes; Added Steve Hankin and
  Glenn Fleirl as authors; Marked as `Proposed Community Standard' as
  per ESE RFC 003; Added ``Motivation for Proposing Standardization''
  (Section~\ref{sec:motivation}); Added note about Error objects in
  ``Overall Operation'' (Section~\ref{sec-overall-operation}).\\
  004.0.01, 28 June 2004, Added Authors section; Added Errata
  section.}

\eseAbstract{This document defines the OPeNDAP Data Access Protocol (DAP), a
data transmission protocol designed specifically for science data.
The protocol relies on the widely used and stable HTTP and MIME standards, and
provides data types to accommodate gridded data, relational data, and time
series, as well as allowing users to define their own data types.}

\begin{document}

\bibliographystyle{plain}

\maketitle

\W\section{Contents}

\W\htmlmenu[0]{3}
\T\tableofcontents

\section{Introduction}

This specification defines the protocol referred to as the Data Access
Protocol, version 2.0 (``DAP/2.0''). In this document `DAP' refers to DAP/2.0
unless otherwise noted.

The \DAP is a protocol for access to data organized as name-datatype-value
tuples. It is particularly suited to accesses by a client computer to data
stored on remote (server) computers which are networked to the client
computer. The protocol has been used by the \acl{DODS} since
1995\cite{gallagher:dods} and subsequently by many other projects and groups.

While the name-datatype-value model is a nearly universal
\emph{conceptual} organization of data, the actual organization of
data takes nearly as many forms as there are individual collections
because there are many different file formats, APIs and file/directory
organizations used to house data. The \DAP was designed to hide the
implementation of different collections of data using an interface
based on the name-datatype-value conceptual model.

%% As the number of different implementations of the \DAP increases, it
%% becomes more important that they all implement the same protocol. There are
%% now several groups which have built servers and
%% clients which support the \DAP. This document
%% provides the normative description of the \DAP. 

\subsection{Motivation for Proposing Standardization}
\label{sec:motivation}

The \DAP and its associated software components (data servers and client
libraries) form the foundation of the National Virtual Ocean Data System
(NVODS). NVODS was developed as a system that facilitates access to
oceanographic data and data products via the Internet, freeing clients
(users) from considerations of: where the data are stored; the format or data
management structure under which they are stored; and (to a significant
degree) the size of the database. NVODS (formerly known as the `Virtual Ocean
Data Hub' -- VODHub ) was created under a 1999 Broad Agency Announcement
(BAA) issued by the National Ocean Partnership Program. The concept of the
VODHub is to be ``a key element of the full community-based `system' to
broaden and improve access to ocean data...'' The resulting NVODS is also
planned for use in the Integrated Ocean Observing System.

Although the \DAP was originally developed by and for the oceanographic
community it has been adopted by a number of meteorological and climate
groups as well and today is extensively used in all three communities -
climate, oceanography and meteorology. SEEDS standardization of the \DAP will
help to accelerate its adoption within these three communities, both through
an increase in developers writing to the specification and through an
increase in those providing their data via the protocol. This will be of
direct benefit to each of the communities individually, and more importantly
it will provide the data interoperability required by researchers interested
in interdisciplinary problems.

It is important to stress the discipline neutrality of the \DAP and the
relationship between this and adoption of the \DAP in disciplines other than
the Earth sciences. First, because the \DAP is agnostic as relates to
discipline, it can be used across the very broad range of data types
encountered in oceanography - biological, chemical, physical and geological.
Oceanography may well be unique in this regard, at least within the
sub-disciplines of Earth Science. But of particular interest here, is that
there is nothing that constrains the use of the \DAP to the Earth sciences.
For example, groups in the solar physics community have adopted the \DAP for
their use and proposals are under consideration in other areas of space
physics. By standardizing the \DAP for the Earth sciences we hope that this
will provide an impetus for other disciplines to adopt it as well.
 
\subsection{Requirements}

The key words ``MUST'', ``MUST NOT'', ``REQUIRED'', ``SHALL'', ``SHALL NOT'',
``SHOULD'', ``SHOULD NOT'', ``RECOMMENDED'', ``MAY'' and ``OPTIONAL'' in this
document are to be interpreted as described in RFC~2119\cite{rfc2119}.

\section{Overall Operation}
\label{sec-overall-operation}

The \DAP is a stateless protocol that governs clients making requests from
servers, and servers issuing responses to those requests. This section
provides an overview of the requests and responses ({\it i.e.} the messages)
which \DAP-compliant software MUST support. These messages are used to
request information about a server and data made accessible by that server,
as well as requesting data values themselves.

The \DAP 2.0 uses \ac{HTTP} as a transport protocol.

The table below provides a description of the \DAP messages. The precise
details of the requests and responses are described in
\Sectionref{sec-requests} and \Sectionref{sec-responses}. A server MUST be
able to provide the responses outlined in
\Tableref[Figure 1]{tab-req-and-resp}. A 
server MAY support additional request-response pairs.

\xmlattributes*{table}{border="1"}
\begin{table}[htbp]
  \begin{center}
\caption{\DAP Requests and Responses}
    \label{tab-req-and-resp}
    \begin{tabular}{p{2.5in}p{2.5in}}
      \tblhd{Request} & \tblhd{Response} \\ \hline

      DDS & DDS or Error \\ \hline

      DAS & DAS or Error \\ \hline

      DataDDS & DataDDS or Error \\ \hline

      Server version & Version information as text \\ \hline
      
      Help & Help text describing all request-response pairs \\\hline

    \end{tabular}
  \end{center}
\end{table}

The \DAP uses three responses to represent a
data source. Two of these responses, the \ac{DDS} and
\ac{DAS}, characterize the variables, their datatypes, names and
atributes. The third response, the \ac{DataDDS}, holds
data values along with name and datatype information.

The \DAP returns error information using an Error response. If a request
for any of the three basic responses cannot be returned, an Error response is
returned in its place.

The three responses (\ac{DAS}, \ac{DDS}
and \ac{DataDDS}) are complete in and of themselves so that, for example, the
data response can be used by a client without ever requesting either of the
two other responses. In many cases, client programs will request the
\ac{DAS} and \ac{DDS} before requesting the \ac{DataDDS}, but there is no
requirement they do so and no server SHALL require that behavior on the part of
clients. 

\note{The first implementation of the \DAP was written in \Cpp
  and the three basic responses correspond to objects in that
  implementation. For this reason these responses are referred to as
  `objects' in some of the \DAP documentation. In some cases it is
  easier to think of these responses as objects and, in those cases, we will
  use that term in this paper, too. See~\Sectionref{sec-responses} for a
  discussion of the object/response duality.}

Operationally, a \DAP client sends a request to a server using \ac{HTTP}. The
request consists of a \ac{HTTP} GET request method, a \ac{URI}\cite{rfc2396}
that encodes information specific to the \DAP (see
~\Sectionref{sec-url-syntax}) and an \ac{HTTP} protocol version number
followed by a MIME-like message containing various headers that further
describe the request. In practice, \DAP clients typically use a third-party
library implementation of \ac{HTTP}/1.1 so the GET request, \ac{URI} and
\ac{HTTP} version information are hidden from the client; it sees only the
\DAP \ac{URL} and some of the request headers. The \DAP server responds with
a status line that includes the \ac{HTTP} protocol version and an error or
success code, followed by a MIME-like message containing information about
the response and the response itself. The \DAP response is the payload of the
MIME-like \ac{HTTP} response.

In addition to these data objects, a \DAP server MAY provide additional
``services'' which clients may find useful. For example, many
\DAP-compliant servers provide an HTML-formatted representations of
a data source's structure and a way to get data represented in CSV-style ASCII
tables. These additional services are not described in this document, but are
instead to be described in ESE Technical Notes.

\subsection{Data Representation}
\label{sec:data-representation}

Data can be an elusive concept.  Data may exist in some storage format
on some disk somewhere, on paper somewhere else, in active memory on
some server, or transmitted along some wire between two computers.
All these can still represent the same data.  That is, there is an
important distinction to be made between the data and its
representation.  The data consist of numbers: abstract entities that
usually represent measurements of something, somewhere.  Data also
consist of the relationships between those numbers, as when one number
defines a time at which some quantity was measured.  

% Paragraph edited based on comments by Raskin. jhrg 12/1/04
The abstract, platonic existence of data is in contrast to its
concrete representation, which is how we manipulate and store it. Data
can be stored as BCD numbers in a file on a disk, or as
twos-complement integers in the memory of some computer, or as numbers
printed on a page. It can be stored in netCDF, HDF, JGOFS, a
relational database and any number of other digital storage forms.

The \DAP specifies a particular representation of data, to be used in
transmitting that data from one computer to another. This representation of
some data is sometimes referred to as the \new{persistent
representation}\footnote{We use the term `persistent representation' instead
of the term `on-the-wire representation' because this representation of values
is often produced by creating a document which is then transmitted but could,
just as easily, be stored in a file system, data base, et c., for later
retrieval and transformed back into the binary information which resided in
the computer's memory. In practice, the on-the-wire and persistent
representations are one and the same, but technically the persistent
representation can be used for other purposes than network transmission.} of
that data, to distinguish it from the representations used in some computer's
memory. The \DAP standard outlined in this document has nothing at all to say
about how data is stored or represented on either the sending or the
receiving computer. The \DAP transmission format is completely independent of
these details.


\section{Characterization of a Data Source}

The \DAP characterizes a data source as a collection of variables. Each
variable consists of a name, a type, a value, and a collection of
\Attributes. \Attributes, in turn, are themselves composed of a name, a type,
and a value (\Sectionref{sec-Attributes}). The distinction between
information in a variable and in an \Attribute is somewhat arbitrary.
However, the intention is that \Attributes hold information that aids in the
interpretation of data held in a variable.\footnote{\Attributes appear in
many data storage systems such as netCDF\cite{netcdf}, HDF4\cite{NCSA:HDF4}
and HDF5\cite{NCSA:HDF5}. They also appear under the moniker `property' in
Common Lisp\cite{steele:clisp}.} Variables, on the other hand, hold the
primary content of a data source.

%%%%% ???
%% A data source's variables are described by two of the three basic responses.
%% The \ac{DDS} response holds the name and datatype of each variable in the
%% data source. It is essentially a declaration of the variables in the data
%% source. Sections~\ref{simple-variables} and~\ref{sec-ctor-vars} describe the
%% diffent types of variables in the \DAP.

%% The \ac{DAS} response holds all of the attribute information for the data
%% source. Attributes are a way to bind extra information to a variable and to
%% an entire data source. While the datatypes supported for attributes are
%% limited to simple types and vectors of simple types, the actual collection of
%% attributes is completely unconstrained. Furthermore, the \DAP does not
%% have any standard set of attributes it requires for variables or data
%% sources. See Section~\ref{sec-das} for more information about the \ac{DAS}
%% response.

%% Both the \ac{DDS} and \ac{DAS} responses describe the data source and the
%% variables it contains. To request data, a client asks a server for a
%% \ac{DataDDS} object. The \ac{DataDDS} class is a subclass of \ac{DDS} and as
%% such it holds information about the names and types of variables in the data
%% source. In addition, a \ac{DataDDS} object holds values for those variables.
%% See Section~\ref{sec-rep-of-values} for information about encoding values in
%% a \ac{DataDDS} response.
%%%%% ???

%%%%%%%%%%%%%%%%%%%%%%%%% Variables %%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Variables}
\label{sec-variables}

%% \note{Some of the next few paragraphs probably belongs in the previous
%%   section or the previous section should be combined/moved here.}

Each variable in a data source MUST have a name, a type and one or more
values. Using just this information and armed with an understanding of the
definition of the \DAP data types, a program can read any or all of the
information from a data source. The names and types of a data source's
variables constitute its \new{syntactic metadata}\cite{cornillon03}.

Each variable MAY have one or more \Attributes associated with it.  For
information about \Attributes, see \Sectionref{sec-Attributes}.

The \DAP variables come in several different types. There are several
\new{atomic} types, the basic indivisible types representing integers,
floating point numbers and the like, and four \new{constructor} types (also
called \new{container} types)  which are flexible collections of
other variables.  Constructor types may contain both atomic variable
types as well as other constructor types.

The \DAP variables describe the data when it is being transferred from
the server to the client. It does not necessarily describe format
inside the server or client. The \DAP defines, for each data type
described in this document, a persistent representation, which is the
information actually communicated between \DAP servers and \DAP
clients. The persistent representation consists of two parts: the
declaration of the type and the encoding of its value(s). For a
description of the persistent representation see
\Sectionref{sec-responses}.

The next two sections describe the abstractions that constitute the variable
type menagerie: the range of values and the kind of data each type can
represent.

%  %  %  %  %  %  %  %  %  %  %  %  %  %  %  %  %  %  %  %  %  %  %  %  %
\subsection{Atomic variables}
\label{sec-atomic-variables}

As their name suggests, \new{atomic} data types are indivisible.
Atomic variables are used to store integers, real numbers, strings and
URLs. There are three families of atomic types, with each family
containing one or more variation:

\begin{itemize}
\item Integer
\item Floating-point types
\item String types
\end{itemize}

\subsubsection{Integer types}
\label{sec-atomic-int}

The integer types are summarized in \Tableref[Figure 2]{tab-ints}.
Each of the types is loosely based on the corresponding data type in
ANSI \C \cite{ANSI:c89}. However, the \DAP, unlike ANSI \C, does
specify the bit-size of each of the integer types. This is done so
that when values are transfered between machines they will be held in
the same type of variable, at least within the limits of the software
that implements the \DAP. Note that the type names are
case-insensitive.

%% In their persistent representation in the \DAP, integer values MUST be
%% stored as \new{twos-complement} \new{big-endian} numbers. 

\xmlattributes*{table}{border="1"}
\begin{table}[htbp]
\caption{The \DAP Integer Data types.}
\label{tab-ints}
\begin{center}
\begin{tabular}{lll}
\tblhd{name} & \tblhd{description} & \tblhd{range} \\ \hline 
\type{Byte} & 8-bit unsigned char & 0 to $2^{8}-1$ \\ \hline
\type{Int16} & 16-bit signed short integer & -$2^{15}$ to $2^{15}-1$ \\ \hline
\type{UInt16} & 16-bit unsigned short integer & 0 to $2^{16}-1$ \\ \hline
\type{Int32} & 32-bit signed integer & -$2^{31}$ to $2^{31}-1$ \\ \hline
\type{UInt32} & 32-bit unsigned integer & 0 to $2^{32}-1$ \\ \hline
%% \type{Int64} & 64-bit signed integer & -$2^{63}$ to $2^{63}-1$ \\ \hline
%% \type{Uint64} & 64-bit unsigned integer & 0 to $2^{64}-1$ \\ \hline
\end{tabular} 
\end{center}
\end{table}

\subsubsection{Floating point types}
\label{sec-atomic-float}

The floating point data types are summarized in \Tableref[Figure 3]{tab-fp}.
The two floating point data types use IEEE~754\cite{IEEE:754} to
represent values.  The two types correspond to ANSI \C's
\texttt{float} and \texttt{double} data types.

%% In their persistent representation, floating point values MUST be
%% stored using big-endian notation.

%% Provision for requesting little-endian numbers is part of a future
%% revision of the DAP.  ts.

\xmlattributes*{table}{border="1"}
\begin{table}[hbtp]
\caption{The \DAP Floating Point Data types.}
\label{tab-fp}
\begin{center}
\begin{tabular}{lp{1.5in}p{2.1in}}
\tblhd{name} & \tblhd{description} & \tblhd{range} \\ \hline
\type{Float32} & IEEE 32-bit floating point\cite{IEEE:754}
     & {\raggedright $\pm 1.175494351 \times 10^{-38}$  to 
       $\pm 3.402823466 \times 10^{38}$} \\ \hline
\type{Float64} & IEEE 64-bit floating point 
     & {\raggedright $\pm 2.2250738585072014 \times 10^{-308}$ to 
       $\pm 1.7976931348623157 \times 10^{308}$} \\ \hline
\end{tabular} 
\end{center}
\end{table}

\subsubsection{String types}
\label{sec-atomic-string}

%%\note{I believe all the current implementations are limited to US-ASCII, but
%%  we should check on that. 05/14/04 jhrg}

The two string data types are summarized in \Tableref[Figure 4]{tab-string}.
The first is a simple string type corresponding to the ANSI \C notion of
a string: a series of US-ASCII characters each represented in a single byte.
%% The first is a simple string type roughly corresponding to the ANSI \C
%% notion of a string: a series of UTF-8 characters each represented by one
%% or more bytes

\String-type values are limited to 32767 bytes.

The \DAP also provides a \URL data type which is the same as \String except
that it MUST be limited to standard (7-bit) US-ASCII characters, due to the
limitations of the syntax of Internet URLs\cite{rfc2396}, and has the
specific meaning of a pointer to some WWW resource.

In \DAP applications \URL is usually used to refer to another data source, in
a manner reminiscent of a pointer.

\Strings are individually sized.  This means that in constructor data
types containing multiple instances of some \String, such as \Sequences
and \Arrays, successive instances of that \String MAY be of different
sizes.

See \Sectionref{sec-rep-of-simple} for other details of the persistent
representation of \Strings.

\xmlattributes*{table}{border="1"}
\begin{table}[hbtp]
\caption{The \DAP \String data types.}
\label{tab-string}
\begin{center}
\begin{tabular}{lp{3.0in}}
\tblhd{name} & \tblhd{description} \\ \hline
\String & a series of US-ASCII characters. \\ \hline
\URL & a series of US-ASCII characters with the restrictions specified in
IETF~RFC~2396\cite{rfc2396} \\ \hline
\end{tabular} 
\end{center}
\end{table}

\subsubsection{A note regarding implementation of the atomic types}

When implementing the \DAP, it is important to match information in a data
source or read from a \DAP response to the {\it local} data type which best
fits those data. In some cases an exact match may not be possible. For
example Java lacks unsigned integer types\cite{Arnold:Java}. Implementations
faced with such limitations MUST ensure that clients will be able to retrieve
the full range of values from the data source. As a practical consideration,
this may be implemented by hiding the variable in question or returning an
error.

If a variable is automatically hidden ({\it i.e.} the server analyzes the data
source and determines that a particular variable cannot be represented
correctly and automatically removes it from those variables made accessible
using the \DAP) this MUST be noted by adding a global \Attribute to the data
source indicating this has taken place. The note MUST include the name of the
variable(s) and the reason(s) for their exclusion. If a variable is removed
by a human, this \Attribute is OPTIONAL. For example, suppose a person
serves data and uses a server which provides a way to choose to serve
only subset of the data source's variables. In that case there's no
need for the server to include a global attribute indicating that has
taken place.

\subsection{Constructor variables} 
\label{sec-constructor-vars}

The \new{constructor} types provide a way to build new data types by
composing existing types. A constructor type MAY contain both atomic
and constructor types. In principle, there are no restrictions on the
number of levels or types of nesting of the constructor types.
However, the \Grid type imposes some limits on the types it may
contain (\Sectionref{sec-constructor-grid}).

There are four constructor data types:

\begin{itemize}
\item \Array
\item \Structure
\item \Grid
\item \Sequence
\end{itemize}

\subsubsection{\Array}
\label{sec-constructor-array}

An \Array is a one-dimensional indexed data structure similar to that defined
by ANSI \C. An \Array's member variable MAY be of any \DAP data type.
\Array indexes MUST start at zero.

Multidimensional \Arrays are defined as \Arrays of \Arrays. Multi-dimensional
\Arrays MUST be stored in \new{row-major} order (as is the case with ANSI
\C). The size of each \Array's dimensions MUST be given. The total number of
elements in an \Array MUST NOT exceed $2^{31}-1$ (2147483647). There is no
prescribed limit on the number of dimensions an \Array may have except that
the foregoing limit on the total number of elements MUST NOT be exceeded.

Each dimension of an \Array MAY also be named.

The number of elements in an \Array is fixed as that given by the size(s) of
its dimension(s).

%% \Arrays of \Strings MAY contain elements of varying lengths.

If you need a data structure which has varying row lengths or an
indeterminate number of rows, consider a \Sequence of \Sequences or a
\Sequence of \Arrays. A \Sequence of \Sequences can represent data
with varying row lengths, and while a \Sequence of \Arrays MUST have
\Arrays of the same length in each instance of the \Sequence, the
total length of the \Sequence is indeterminate.  See
\Sectionref{sec-constructor-sequence}. 


\subsubsection{\Structure}
\label{sec-constructor-structure}

A \new{Structure} groups variables so that the collection can be manipulated
as a single item. The \Structure's member variables MAY be of any type,
including other constructor types. The order of items in the \Structure is
significant only in relation to the persistent representation of that
\Structure.

There is a special case of the \Structure data type, called \Dataset. This is
the container that encompasses all the variables provided in some data
source.

\subsubsection{\Grid}
\label{sec-constructor-grid}

A \Grid is a special case of a \Structure, used to supply information to aid
in the interpretation of \Arrays. A \Grid sets up an association between a
target \Array and a collection of map vectors.

A \Grid is an association of an $N$ dimensional \Array with $N$ vectors
(\new{map vectors}), each of which MUST have the same number of elements and
the same name as the
corresponding dimension of the \Array. Each vector is used to map indexes of
one of the \Array's dimensions to a set of values which are normally
non-integer ({\it e.g.} floating point values).

Schematically, a two-dimensional \Grid is the following:
\T\nopagebreak
\begin{displaymath}
  \begin{array}{cl}  & \left[
      \begin{array}{ccccc}
        x_0~~  & x_1~~    & x_2~~    & \cdots & x_n~~     \\
      \end{array} \right] \\[2mm] \left[
      \begin{array}{c}
        y_0 \\ y_1 \\ y_2 \\ \vdots \\ y_m
      \end{array} \right] & \left[
      \begin{array}{ccccc}
        z_{0 0} & z_{0 1} & z_{0 2} & \cdots & z_{0 n} \\
        z_{1 0} & z_{1 1} & z_{1 2} & \cdots & z_{1 n} \\
        z_{2 0} & z_{2 1} & z_{2 2} & \cdots & z_{2 n} \\
        \vdots  & \vdots  & \vdots  & \ddots & \vdots  \\
        z_{m 0} & z_{m 1} & z_{m 2} & \cdots & z_{m n} 
      \end{array} \right]
  \end{array}
\end{displaymath}

Each column of the $z$ \Array corresponds to an entry in the $x$ map vector,
and each row of $z$ corresponds to some $y$ value. So, for example, the data
value at $z_{42,33}$ corresponds to the values $y_{42}$ and $x_{33}$.

For example, a geo-referenced \Grid might have map vectors that
represent the longitude and latitude of each row, so that if you know
that the twelfth value of the longitude array is -54, you know that
all the values in the twelfth column correspond to longitude 54
degrees west.

%%%% A figure here would be a good thing.


%%%% The following paragraph is self-contradictory, I think.  james? Yes.
%%%% Removed. 
%% The \Grid type was created to deal with geo-located data, with irregular
%% spacing of the rows and columns, which is useful when converting to and from
%% different map projections. But the \Grid structure is more generally useful.
%% For example, one of the map vectors could be an \Array of $(x,y)$ pairs
%% (stored in a \Structure), and the other a series of time values, and the
%% \Grid would become a record of several synoptic time series. 

The maps MUST be vectors of atomic types.\footnote{This restriction has been
put in place to keep writing general clients tractable. If the set of data
types in a \Grid's map \Arrays is allowed to be a \Sequence, for example, any
general client would have to be capable of processing that data type in a
response. Such a client would be very hard to build.}

\subsubsection{\Sequence}
\label{sec-constructor-sequence}

A \Sequence can best be described as an ordered collection of zero or more
\Structures. Each instance in the series consists of the same set of
variables, but contains different values.

The semantics of the \Sequence data type are very close to those of a table
in a relational database. You can think of the instances in a \Sequence as
rows in a traditional relational table. OPeNDAP servers that serve data from
a DBMS like Oracle or mySQL use \Sequences to reflect the structure of their
data.

A \Sequence $S$ can be represented as:

\begin{displaymath}
  \begin{array}{cccc}
    s_{0 0} & s_{0 1} & \cdots & s_{0 n} \\
    s_{1 0} & s_{1 1} & \cdots & s_{1 n} \\
    \vdots & \vdots  &         & \vdots \\
    s_{i 0} & s_{i 1} & \cdots & s_{i n} \\
    \vdots & \vdots  & \vdots & \vdots
  \end{array}
\end{displaymath}

Where each $s_0 \cdots s_n$ entry represents a set of \DAP variables,
and the collection of such entries constitutes the \Sequence. Every
entry of \Sequence $S$ MUST have the same number, order, and type of
variables. If $s_{0 0}$ is a \type{Float64}, then all the $s_{i 0}$
values MUST also be \type{Float64} variables. Similarly, in a
\Sequence which contains an \Array or \Structure, each instance of the
\Array or \Structure MUST be the same size. However, a \Sequence MAY
contain a \Sequence and each instance of the interior \Sequence MAY
have a different number of entries.

Unlike an \Array, a \Sequence has no explicit size.

Though the semantics of \Sequences places limitations on the kinds of
requests a client may make of a server, once the \Sequence has been
retrieved, a client program may reference it in any way desired. The \DAP
defines the persistent representation of data types, and the interaction
between client and server (which includes what kinds of requests can be made
for what kind of variables), but the \DAP does not specify the internal
implementation of the data types for any client or server.

\subsection{Attributes}
\label{sec-Attributes}

\Attributes are used to associate semantic metadata with the variables in a
data source. Attributes are similar to variables in their range of types and
values, except that both are somewhat limited when compared to those for
variables. Attributes are encoded using the DAS response, and the
relationship of that to the DDS response places some extra restrictions on
attributes (See \Sectionref{sec-das}).

%% There is only one container type for attributes, the structure.
%% The atomic types mirror those of variables, but the values are limited to
%% scalars and vectors; multi-dimensional arrays are not allowed. Furthermore,
%% the organization of attributes is determined the organization of the
%% variables. There must be a one-to-one correspondence between the hierarchy
%% established by a data sources's constructor types (Structure, Sequence and
%% Grid) and the hierarchy of attributes established by attribute structures.

Each variable in a data source MAY have \Attributes associated with it
(called \new{variable attributes}) and the entire \Dataset (see
\Sectionref{sec-constructor-structure}) MAY itself have \Attributes, called
\new{global \Attributes}.

%% All \Attributes are held within
%% \new{Attribute Structures}, even when there is only one \Attribute
%% associated with a variable. Global \Attributes are held in \Attribute
%% \Structures at the top level of the \Dataset.

While the \DAP does not require any particular \Attributes, some may be
required by various \new{metadata conventions}. The \new{semantic metadata}
for a data source comprises the \Attributes associated with that data source
and its variables\cite{cornillon03}.  Thus, \Attributes provide a
mechanism by which semantic 
metadata may be represented without prescribing that a data source use a
particular semantic metadata convention or standard.

The data model for \Attributes is somewhat simpler than that for variables.
An \Attribute's type MUST either be a \Structure or one of the
atomic types listed below. If the type of the \Attribute is one of the
atomic types, the value MAY be either scalar or one-dimensional
\Array.  \Attributes MAY NOT be multi-dimensional arrays.

If an attribute in a particular data source ({\it e.g.} an HDF5 file) is a
multi-dimension \Array, it is suggested that the \Attribute be promoted to a
variable and that a new \Attribute be created for that variable which
describes the promotion. This fits the paradigm of remote access better since
the multi-dimensional array information would then be accessed with a
constraint expression. Since constraint expressions can only be applied to
variables, it makes sense to promote such data to a variable.

An \Attribute's value MAY be any of the following atomic types:
\begin{itemize}
\item \lit{Byte}
\item \lit{Int16}
\item \lit{UInt16}
\item \lit{Int32}
\item \lit{UInt32}
%% \item \lit{Int64}
%% \item \lit{UInt64}
\item \lit{Float32}
\item \lit{Float64}
\item \lit{String}
\item \lit{URL}
\end{itemize}
 
The range of values for atomic type \Attributes is the same as for the atomic
variable types. See~\Sectionref{sec-das} for information on the persistent
representation of atomic-type \Attributes.

\subsection{Attribute Structures}
\label{sec-attr-structure}

An \Attribute structure is a container which MAY be empty or which MAY
contain atomic type \Attributes and/or \Attribute structures.
Semantically, an \Attribute structure is equivalent to the \Structure
variable type; it provides a way to form logical groupings and hierarchies of
\Attributes. An \Attribute structure MAY NOT directly contain values, only
other \Attributes and \Attribute \Structures.

\subsection{Attribute organization}
\label{sec-attribute-organization}

Each variable MUST have an associated \new{Attribute Structure} and the
hierarchy formed by these containers MUST mirror the hierarchy of variables
in the data source. There is no requirement that a \Dataset have an
\Attribute \Structure if it has no global \Attributes. This is one way in
which the \Dataset, which is similar to \Structure-type variable, is treated
specially. All other \Structure variables are REQUIRED to have an associated
\Attribute \Structure (as are ALL variables) but the \Dataset has no such
requirement.

%% See~\Sectionref{sec-das} for more information about the organization
%% of \Attributes and \Attribute containers.

%% \subsection{Attribute Aliases}
%% \label{sec-attribute-aliases}

%% \note{I think this should be removed. 05/18/04 jhrg}
 
%% A special type of \Attribute is \new{alias}. An \Attribute MAY be aliased,
%% with an \Attribute of one name referring to a different \Attribute. An
%% \Attribute of one variable MAY be an alias that refers to an \Attribute of
%% another variable. \Attribute aliases MAY only refer to \Attributes. They MAY
%% NOT refer to other \Attribute aliases.

%% An \Attribute alias MUST be defined using the \FQN of
%% the \Attribute to which it refers. See \Sectionref{sec-FQN}

%% See the discussion of the \Attribute \lit{alias} type in
%% \Sectionref{sec-xml-Attribute-Alias} for specific information about the
%% syntax of an \Attribute \lit{alias}.

\section{Constraint Expressions}
\label{sec-ce}

A \new{\CE} provides a way for \DAP client programs to request certain
variables, or parts of certain variables, from a data source. Many data
sources are large and many variables from those sources are also large. Often
clients are interested in only a small number of values from the entire data
source. Constraint expressions provide a way for clients to tell a server
which variables, and in many cases, which parts of those variables, they
would like.

This section presents the subsampling abilities that MUST be provided by a
\DAP server, without binding these capabilities to any particular
syntax; see \Sectionref{sec-ce-syntax} for the representation of a \CE. Some
implementations MAY choose to implement additional syntaxes but MUST
implement the syntax described there.

An empty \CE implies that the entire data source is to be accessed.

\subsection{Limiting data by type and by value}
\label{sec-ce-clauses}

A \CE provides two different methods to access the information held by
a data source. The \CE can be used to limit data using the names
and/or dimensions of variables or by scanning variables and returning
only those values that satisfy certain relational expressions. The
former are referred to as \new{projections} while the latter are
called \new{selections}.

A \CE MAY combine both projection and selection constraints. For example, a
projection might specify that temperatures held in a \Sequence are to be
returned, and a selection would specify that only \Sequence entries with
dates later than 1999 are to be examined. The result returned from a request
like this would be a \Sequence of temperature measurements taken after 1999.

\Sectionref{sec-ce-projections} describes the projection operations which any
\DAP implementation MUST support and, likewise,
\Sectionref{sec-ce-selections} describes the required selection operations.

To provide implementors with a means to extend the \CE mechanism, it is
possible to add functions to a server and to call those as part of the \CE.
Functions are described in \Sectionref{sec-ce-functions}.

\subsubsection{Projections}
\label{sec-ce-projections}

% Describe the types of projection operations
% Choosing parts based on field names
% Choosing parts based on hyperslabs

The \new{projection clause} of a \CE provides a way to choose parts of
a data set based on the data types of the variables in a \Dataset.
There are two types of projection operations. First, it is possible to
choose individual fields of the constructor data types. This is called
\new{field projection} and applies to the \Structure, \Grid and
\Sequence data types in the following ways:
\begin{description}
  \item[\Structure] A field projection which chooses one or more fields from
  a \Structure variable causes a \DAP server to return only those named
  fields from the \Structure. Note that the \Dataset itself is similar to a
  \Structure. It differs in that it MAY have an attribute container (while
  all other variables MUST) and it MUST NOT be included in forming fully
  qualified names (See~\Sectionref{sec-names}).

  \item[\Grid] A field projection which chooses one or more fields from
  a \Grid variable causes a \DAP server to return only those named
  fields from the \Grid. It is likely that the variable returned will no
  longer meet the criteria for a correctly formed \Grid data type, so the
  variable may be returned as a \Structure instead (see 
  \Sectionref{sec-ce-transform}).

  \item[\Sequence]  A field projection which chooses one or more fields from
  a \Sequence variable causes a \DAP server to return only those named
  fields from the \Sequence. For the \Sequence type, this means returning the
  $N$ instances but limiting the fields those given in the field
  projection. For example, suppose the \Sequence $S$ has $P$ fields:
  
 \begin{displaymath}
 \begin{array}{cccc}
   s_{0, 0} & s_{0, 1} & \ldots & s_{0, P-1} \\
   s_{1, 0} & s_{1, 1} & \ldots & s_{1, P-1} \\
    \vdots & \vdots  & & \vdots  \\
   s_{N-1, 0} & s_{N-1, 1} & \ldots & s_{N-1, P-1} \\
 \end{array}
 \end{displaymath} 
 
If a field projection is used to choose only the second field, the result of
accessing $S$ would be:
 \begin{displaymath}
 \begin{array}{c}
   s_{0, 1}\\
   s_{1, 1}\\
   \vdots \\
   s_{N-1, 1}\\
 \end{array}
 \end{displaymath}
\end{description}

When a projection in a \CE contains the name of a constructor-type variable,
the response MUST include all of the members of that variable. If a
projection includes the name of a variable that is not fully qualified
(See~\Sectionref{sec-names}) the response SHOULD include that variable as if
the fully qualified name was given. This provides a shorthand notation for
members of a constructor. Suppose there is a \Structure names \lit{foo} with
a member named \lit{bar}. Including \lit{bar} in a \CE would cause the
\lit{foo.bar} to be included in the response. If a name appears in more than
one place in a \Dataset (for example, suppose a \Grid is named \lit{SST} and
has a member \Array also named \lit{SST}) the \CE evaluator MUST treat the
name as fully qualified and include either the matching variable in the
response or return an Error response if no variable matches.

When using a field projection, it is possible to request all of the members
of a constructor-type variable by using just the name of the constructor.

The second type of projection is a \new{hyperslab}. A hyperslab is
used to limit returned data to those elements that fall within a range
of index values, and MAY also specify that the range be subsampled
using a \new{stride}. By including a hyperslab projection for one or
more dimensions of a variable it is implied that any unnamed
dimensions are to be returned in their entirety. A hyperslab is
applied to the \Array, \Grid and \Sequence types in the following way:
\begin{description}
  \item[\Array] \Array dimensions are numbered $0, \ldots, N-1$ for an
    \Array of rank $N$. Within each dimension of size $M$, elements
    are numbered $0, \ldots, M-1$. A hyperslab projection for
    dimension $n, 0 \leq n < N$ MUST include either the starting index
    $i_{n_{s}}$ and ending index $i_{n_{e}}$ such that $i_{n_{s}} \leq
    i_{n_{e}} \forall \{ 0 \leq i_{n} < M \}$ or include ONLY a
    starting index. In the later case the hyperslab causes the single
    element corresponding to the index to be projected.\footnote{The
      use of the phrase {\it starting index} is misleading. We use
      the term to remain consistent with older documentation.} Note
    that the starting index is zero-based, so the first element is
    returned using the hyperslab $[0]$ and the $N^{th}$ element is
    returned using the hyperslab $[N-1]$. 

    The stride value gives the distance between adjacent elements in
    the source data. If not given, stride defaults to one (1) which
    causes all elements to be returned. If, for example, a stride of
    two (2) is given, then every other element would be returned.
    Sampling starts at the starting index and procedes until the index of
    the current element is less than or equal to the ending index.
    Thus a hyper slab such as $[0:2:5]$ would contain elements $0, 2,
    4$ from the source data. If a stride is included in the hyperslab
    and is greater than $i_{n_{e}} - i_{n_{s}} + 1$ then the hyperslab
    is equivalent to one where $i_{n_{s}} = i_{n_{e}}$ and the
    original value of $i_{n_{e}}$ is discarded.\footnote{A stride
      value is only meaningful when a projection contains a range of
      values indicated by both a start and end value; stride is not
      meaning full when the projection consists of a start value
      only.}

    The number of elements returned as a result of a hyper slab is
    given by the relation 
    $\lfloor ( i_{n_{e}} - i_{n_{s}} ) / stride \rfloor + 1$.

\item[\Grid] \Grid dimensions are numbered as are \Array dimensions; \Grid
  dimensions MAY have hyperslab projections applied to them in a manner
  similar to \Arrays except that a hyperslab applied to a \Grid is
  applied to not only the target array, but also all the corresponding map
  arrays. For example, given the \Grid:
\begin{displaymath}
  target = 
   \left[
    \begin{array}{cccc}
      1 & 2 & 3 & 4 \\
      5 & 6 & 7 & 8 \\
      9 & 10 & 11 & 12 \\
      13 & 14 & 15 & 16
    \end{array} \right],
   map_{1} = 
   \left[
    \begin{array}{cccc}
      -53 & -52 & -51 & -50
    \end{array} \right],
   map_{2} = 
   \left[
    \begin{array}{c}
      26 \\
      25 \\
      24 \\
      23 
    \end{array} \right]
\end{displaymath}
A hyperslab projection which chose row indexes 1 and 2 and column indexes 1
and 2 would cause a server to return:
\begin{displaymath}
  target = 
   \left[
    \begin{array}{cc}
      6 & 7\\
      10 & 11
    \end{array} \right],
   map_{1} = 
   \left[
    \begin{array}{cc}
      -52 & -51
    \end{array} \right],
   map_{2} = 
   \left[
    \begin{array}{c}
      25 \\
      24
    \end{array} \right]
\end{displaymath}
for the \Grid.

Note that a field and hyperslab projection can be combined for a \Grid
to choose only part of one of the fields, say just part of the target
\Array. In this case, the hyperslab applied to one field of the \Grid
is equivalent to a hyperslab applied to an \Array. The field
projection yields an \Array and the hyperslab is then applied to that
\Array.

\item[\Sequence] A hyperslab can be applied to a \Sequence. A
  \Sequence with $M$ instances can have a hyperslab projection applied
  to it as if it is an \Array of rank 1. Since the \Sequence type does
  not contain an explicit dimension size, the size $M$ is not known
  until the entire \Sequence is accessed.\footnote{For many \Sequence
    variables, it may never be the case that the entire \Sequence is
    accessed since it may contain millons of instances.} A hyperslab
  projection can be used to ask for the first $m$ elements, the next
  $m$ elements, et c., which may be very useful for clients which need
  to know the sizes of varaibles before accessing them. A hyperslab
  projection for a \Sequence $(i_{s}, i_{e})$ will return $m$
  instances of the \Sequence such that $m = \lfloor i_{e}, M-1 \rfloor
  - i_{s} + 1$ depending on whether $i_{e}$ is an index greater than
  the number of instances in the \Sequence. \Sequence instances are
  indexed starting with zero.
\end{description}

It is possible to ask for values from several variables in a single \CE by
including several projections in the \CE. Also note that an empty \CE, by
convention, projects all of every variable in a data source.

\subsubsection{Selections}
\label{sec-ce-selections}

% Describe the types of selection operations
% Choosing parts based on relational expresssions
% binding selections to a selectable data type

A \new{selection} provides a way to limit data accessed based on the value(s)
of those data. In many ways selections are similar to WHERE claues in
SQL\cite{date:DBMS}. A selection is composed of one or more relational
sub-expressions. Each sub-expression MUST be bound to a variable listed in a
projection clause. When several sub-expressions constitute a selection, the
boolean value of the selection is the logical \lit{AND} of each of the
boolean values of each sub-expression. Note that there is no way to perform a
logical \lit{OR} operation on the sub-expressions but there is a way, within
a sub-expression, to test several values and return \lit{true} if any satisfy
the relation.

Each of the relational sub-expressions ({\it i.e.} relations) is
composed of two operands and a relational operator. Each operand MUST
be an atomic data type; it MAY be a \FQN from the data source or a
constant. Note that it is possible to have a relational sub-expression
consist of two \FQNs from the data source or a single \FQN and either
a single constant or a set of constants. In some cases there are
further limitations on the allowed types based on the relational
operator. \Tableref[Figure 5]{tab-ce-relations} lists the operators,
their meaning and the data types on which they may be applied.

\xmlattributes*{table}{border="1"}
\begin{table}[htbp]
  \begin{center}
\caption{\DAP Selection Relational Operators}
    \label{tab-ce-relations}
%    \begin{tabular}{p{.75in}p{1.5in}p{2.0in}} \\
    \begin{tabular}{cp{1.5in}p{2.0in}} 
      \tblhd{Operator} & \tblhd{Meaning} & \tblhd{Types} \\ \hline

      \verb+<+ & Less than 
      & Byte, Int16, Int32, UInt16, UInt32, Float32, Float64 \\ \hline

      \verb+<=+ & Less than or equal to 
      & Byte, Int16, Int32, UInt16, UInt32, Float32, Float64 \\ \hline

      \verb+>+ & Greater than 
      & Byte, Int16, Int32, UInt16, UInt32, Float32, Float64 \\ \hline

      \verb+>=+ & Greater than or equal to 
      & Byte, Int16, Int32, UInt16, UInt32, Float32, Float64 \\ \hline

      \verb+=+ & Equal 
      & Byte, Int16, Int32, UInt16, UInt32, Float32, Float64, String,
      Url \\ \hline

      \verb+!=+ & Not equal 
      & Byte, Int16, Int32, UInt16, UInt32, Float32, Float64, String, Url 
      \\ \hline

      \verb+=~+ 
      & Regular expression match & String, Url \\ \hline

    \end{tabular}
  \end{center}
\end{table}

Operands in a \CE selection MAY be either variables in the data source or
constants. When constants are used in a selection sub-expression they MAY be
either single or multi-valued. If a constant 
operand has more than one value, each value is used in succession when
evaluating the relation. For example, suppose there is a relation: 

\begin{vcode}{it}
site = {"Diamond_St", "Blacktail_Loop"}
\end{vcode}

Then that relation is true for any instance where \lit{site} is either
\lit{Diamond\_St} OR \lit{Blacktail\_Loop}.

When a variable appears in a selection sub-expression it MUST be single
valued. 

Selections MAY ONLY be applied to the \Sequence data type in the following way:

\begin{description}
  \item[\Sequence] Logically, the relations in a selection bound to a
    \Sequence are evaluated once for every instance ({\it i.e.} row) of the
    \Sequence; the result of applying the selection to the \Sequence is a
    \Sequence where all of the instances satisfy all of the relations.

    A \Sequence $S$ with three fields and four instances (an example of a two-level \Sequence can be found on Section~\ref{seq:2-level}) such as:
    \begin{displaymath}
      \begin{array}{ccc}
        index & temperature & site \\
        10 & 15.2 & Diamond\_St \\
        11 & 13.1 & Blacktail\_Loop \\
        12 & 13.3 & Platinum\_St \\
        13 & 12.1 & Kodiak\_Trail \\
      \end{array}
    \end{displaymath}
    A selection such as \verb+index>=+ 11 would choose the last three instances:
    \begin{displaymath}
      \begin{array}{ccc}
        index & temperature & site \\
        11 & 13.1 & Blacktail\_Loop \\
        12 & 13.3 & Platinum\_St \\
        13 & 12.1 & Kodiak\_Trail \\
      \end{array}
    \end{displaymath}
    The selection \verb+site=~ ".*_St"+ would choose two instances:
    \begin{displaymath}
      \begin{array}{ccc}
        index & temperature & site \\
        10 & 15.2 & Diamond\_St \\
        12 & 13.3 & Platinum\_St \\
      \end{array}
    \end{displaymath}
    And a selection with the two sub-expressions \verb+index<=+11, 
    site\verb+=~".*_St"+ would return only one instance:
    \begin{displaymath}
      \begin{array}{ccc}
        index & temperature & site \\
        10 & 15.2 & Diamond\_St \\
      \end{array}
    \end{displaymath}
    Finally, a selection can relate two variables.
    \verb+index>temperature+ would return:
    \begin{displaymath}
      \begin{array}{ccc}
        index & temperature & site \\
        13 & 12.1 & Kodiak\_Trail \\
      \end{array}
    \end{displaymath}

\end{description}

\subsubsection{Server Functions}
\label{sec-ce-functions}

A \CE MAY also use functions executed by the server. These can appear in a
selection or in a projection, although there are restrictions about the data
types functions can return. 

% Functions in projections
% Functions in selections
% Functions and errors

A function which appears in the projection clause MAY return any of the \DAP
data types. In this case the return value of the function is treated as if it
is a variable present in the top level of the \Dataset (see
\Sectionref{sec-constructor-structure}). 

A function which appears in the selection clause MAY return any atomic type
if it is used in one of the relational sub-expressions. If a function in the
selection clause is used as the entire sub-expression, it MUST return an
integer value. If that value is zero, the function will evaluate as boolean
false, otherwise it will evaluate as boolen true.

% I think this should stay here; we need to provide for an unambiguous way to
% get error information back to clients. I think that has to come from this
% level and not vary per transport. The transports are free to implement
% error returns however they can. 10/27/03 jhrg
When functions encounter an error, a \DAP server MUST signal that condition
by returning an error response. A server MAY NOT return a partial response;
any error encountered while evaluating the \CE MUST result in a response that
contains an unambiguous error message.

%  %  %  %  %  %  %  %  %  %  %  %  %  %  %  %  %  %  %  %  %  %  %  %  %
\subsection{Data Type Transformation Through Constraints}
\label{sec-ce-transform}

When a constraint expression has a projection clause that identifies a piece
of a constructor variable, such as one field of a \Structure or just the
array part of a \Grid, the \new{lexical scoping} of the variable is not
abandoned. This is important for avoiding name collisions. For example, if a
single item is requestd from a \Structure, the response MUST contain a
\Structure with only that item.

Here is the behavior for each data type:

\begin{description}
\item[\Array] An \Array MUST be returned as an \Array of the same rank as
  the source \Array (same number of dimensions). A hyperslab request
  that effectively eliminates a 
  dimension by reducing its size to $1$ does \emph{not} reduce the rank of
  the returned \Array. For example, suppose a 10 by 10 element \Array was
  subsampled to a 1 by 2 \Array. The returned variable would still be
  described as a two dimensional \Array.
  
\item[\Structure] A \Structure MUST be returned as a \Structure. If the
  projection clause of a \CE selects only one member of the \Structure, then
  a one-member \Structure MUST be returned. If more than one member of the
  \Structure are named in the projection clause, they MUST be returned in the
  same \Structure.
  
\item[\Grid] A \Grid modified with a hyperslab operator MUST return another
  \Grid, following the same rules as an \Array. But if the projection clause
  specifies the elements of the \Grid independently of one another---the
  target array, or one of the maps---then a \Structure is returned containing
  only the specified variables. A two-dimensional \Grid named \lit{Cloud}
  will return a \Grid in response to a request like this:
  \lit{Cloud[1:10][20:30]}. But a request for the target array
  alone---\lit{Cloud.Cloud[1:10][20:30]}--- returns a \Structure called
  \lit{Cloud} containing an \Array called \lit{Cloud}. In this example, the
  map arrays are not returned.

%%   A \Grid modified with a selection MUST remain a \Grid. The return value of
%%   such a constraint MUST be the smallest rectangular \Grid that contains all
%%   the data points that satisfy ther given constraint. Further, the rank of the
%%   \Grid MUST remain the same. A four-dimensional \Grid, when sampled with a
%%   selection clause, MUST return a four-dimensional \Grid, even if some
%%   of the dimensions are of length one.
  
\item[\Sequence] A \Sequence MUST be returned as a \Sequence, even
  if a selection clause selects only a single entry or no entry at
  all.  If a projection clause identifies more than one member of the
  \Sequence, they MUST be returned in the same \Sequence.

\end{description}

\section{Names}
\label{sec-names}

This section describes the persistent representation of names.

A \DAP variable's name MUST contain ONLY US-ASCII characters with the
following additional limitation: The characters MUST be either upper or lower
case letters, numbers or from the set \verb+ _ ! ~ * ' - " +. Any other
characters MUST be escaped.

\subsection{Escaping characters in names}

To escape a character in a name, the character is replaced by the sequence
\verb+%<Character Code>+ where \emph{Character Code} is the two
hex digit code corresponding to the US-ASCII character. Note that the
characters \verb+(+ and \verb+)+ (left and right parenthesis) must be escaped
because those are used in the \CE syntax and not escaping them makes it
impossible to parse certain \CEs. Similarly, the \verb+.+ (period) character
MUST be escaped when it appears as part of the name of a variable because it
is used as the separator between names in a \FQN. Thus, not escaping the
period would make it impossible to parse certain \CEs.

\subsection{Constructor variable names}

The members of a constructor variable can be individually addressed in the
following fashion:

\begin{description}
\item[\Array] Individual \Array items MUST be addressed with a subscripted
  expression. For an \Array named \lit{Temp}, the fourteenth member of the
  \Array is referenced as \lit{Temp[13]} (all indexes start at zero). A
  two-dimensional \Array is addressed with two subscripts, contained in
  separate brackets: \lit{SurfaceTemp[13][3]}. See \Sectionref{sec-ce-syntax}.

\item[\Structure] Members of a \Structure are addressed by appending
  the member name to the \Structure name, separated by a dot
  (\lit{.}).  If the \Structure \lit{Position} has a member named
  \lit{Height}, then it is addressed as \lit{Position.Height}.
  The members of a \Structure MUST have different names from one
  another. 

\item[\Grid] The arrays in a \Grid MAY be referenced in the same
  fashion as the members of a \Structure. For a two-dimensional \Grid
  named \lit{Cloud}, with one-dimensional map vectors \lit{Latitude}
  and \lit{Longitude}, a member of a map vector is addressed like
  this: \lit{Cloud.Latitude[36]}. This refers to a single value from
  the \lit{Latitude} array. It is also possible to request part of the
  target array: \lit{Cloud.Cloud[36][42]}, which will return a single
  data measurement. The \Grid itself MAY be addressed like an \Array:
  \lit{Cloud[36][42]}, which will return a \Grid containing the value
  \lit{Cloud.Cloud[36][42]} along with the two map vectors
  (\lit{Cloud.Latitude[36]} and \lit{Cloud.Longitude[42]}). See
  \Sectionref{sec-ce-transform} for an explanation of how data types
  are transformed by constraints.

\item[\Sequence] A \Sequence member is addressed in the same fashion as a
  \Structure. That is, a time called \lit{Releasedate} of a \Sequence named
  \lit{Balloons} is addressed as \lit{Balloons.Releasedate}. But note that
  unlike a \Structure, this name references as many different values as there
  are entries in the \lit{Balloons} \Sequence. A single entry or range of
  entries in a \Sequence MAY be addressed with a hyperslab operator like the
  items in an \Array. The variables in a \Sequence MUST have different names
  from one another.
\end{description}

\subsection{Fully Qualified Names}
\label{sec-FQN}

The lexical scoping rules of the \DAP require some description. The
important concept is the \new{fully qualified name}, which is an
unambiguous name for some variable or attribute.

\subsubsection{Variable Names}

The \FQN of a variable is composed of the ordered collection of variable
names, starting at the \Dataset level but not including the \Dataset name,
that can be followed to the terminal variable name. The names MUST be
separated by the dot (.) character. Thus, if a \Dataset named \lit{test}
contains a structure named \lit{sst} which contains a variable named
\lit{foo}, the \FQN would be \lit{sst.foo}.

\subsubsection{Attribute Names}

The \FQN of an \Attribute is composed of the ordered collection of \Attribute
names, starting at the \Dataset level but not including the \Dataset name,
that can be followed to the terminal source \Attribute. The names MUST be
separated by the dot (.) character. Thus, if a \Dataset named \lit{test}
contains a structure named \lit{sst} which contains a variable named
\lit{foo}, the \FQN of the \Attributes of foo would be \lit{sst.foo}. If
\lit{foo} possessed an \Attribute named \lit{fruit} then the \FQN for
\lit{fruit} would be \lit{sst.foo.fruit}.

\note{Forming the \FQN for an \Attribute is largely a formality in DAP/2.0
since it is only possible to request all of the \Attributes. However, the
requirements are included here as a guide. Future versions of the DAP may
require its implementation.}



%%%%%%%%%%%%%%%%%%%%%%%%%%% dividing line %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Requests}
\label{sec-requests}

The \DAP is a client-server protocol: the client makes a request
of the server, and the server responds with some information.  The
request and response travel via \ac{HTTP}.  This section describes the form
of requests to servers.


\subsection{URL Syntax}
\label{sec-url-syntax}
A \DAP \ac{URL} is essentially an \ac{HTTP} \ac{URL}\cite{rfc2616} with
additional restrictions placed on the \lit{abs-path} component.

\begin{vcode}{cft}
DAP-URL        =  "http://" host [ ":" port ] [ abs-path ]
abs-path       =  server-path data-source-id [ "." ext [ "?" query ] ] 
server-path    =  [ "/" token ] 
data-source-id =  [ "/" token ] 
ext            =  "das" | "dds" | "dods" 
\end{vcode}

One possible implementation can divide these as followed: The
\lit{server-path} is the pathname to the server, whereas
\lit{data-source-id} is the pathname to the data. In reality the
disticntion between the two components is arbitrary.

The \DAP uses \ac{HTTP} as its session protocol\cite{stevens:unp},
%%%% need a better reference
so every \DAP \ac{URL} starts with the scheme
\lit{http:}. The \lit{host} and optional \lit{port} name a host and
TCP port of an \ac{HTTP} server that will handle the session. The
\lit{host} may also contain authentication information as described in
RFC~2617\cite{rfc2617}.

The \lit{abs-path} portion of the \lit{DAP-URL} is composed of four
parts:
\begin{description}
\item [server-path] A pathname which identifies the \DAP server to
  handle the request. The servers may be implemented as \ac{CGI}
  programs or they may use another equivalent scheme ({\it e.g.} the
  Apache \ac{HTTP} daemon's module system).

\item [data-source-id] A string passed to the server named by
  \lit{server-path} that uniquely identifies the source of data on
  \lit{host}. The \lit{data-source-id} may take the form of a pathname
  within the \ac{HTTP} server's document root directory, or it may name the
  data source in some other way ({\it e.g.} the \DAP server might maintain a
  table of names mapped to tables in a relational database).
  
  Two special \lit{data-source-id}s MUST be recognized by a \DAP
  server. They are \lit{version} and \lit{help}. When a \DAP server
  receives the \lit{data-source-id} \lit{version} it MUST respond
  with version information (see~\Sectionref{sec-version}). When a \DAP
  server receives the \lit{data-source-id} \lit{help} it MUST respond
  with a help message (see~\Sectionref{sec-help}).

\item [ext] The optional \lit{ext} part of the \lit{abs-path} tells
  the \DAP server which type of response to return. Each response has
  a string that is used by the requester.
  See~\Sectionref{sec-responses} for a description of the responses
  and the \lit{ext} strings used to request them.\footnote{The
    \lit{ext} is optional because it is possible to request either the
    version or help response using a special \lit{data-source-id} of
    \lit{version} or \lit{help}, respectively.
    See~\Sectionref{sec-version}~and~\Sectionref{sec-help}.}

\item [query] The optional \lit{query} part of the \lit{abs-path} is
  used with data requests to limit those requests to specific
  variables or values within the data source.
  See~\Sectionref{sec-ce-syntax}. The \lit{query} part MUST ONLY be
  used with the \lit{dds} and \lit{dods} \lit{ext}.
\end{description}

\subsubsection{Constraint expressions}
\label{sec-ce-syntax}

A \ac{CE} provides a way for clients to request certain variables, or parts
of certain variables, from a data source. This section describes the syntax
used to encode a \CE so that it can be sent, as part of a request, to a
server. See~\Sectionref{sec-ce} for a general discussion of \CEs and the rules for
their evaluation.

Some implementations of the \DAP MAY choose to provide alternate \CE
syntax, but all implementations MUST provide the one described here.

Constraint expressions have the following syntax:

%%%% Needs review
\begin{vcode}{cft}
CE         = [ projection ] *("\&" selection) 
projection = variable | variable "," projection 
variable   = id | function 
function   = id "(" args ")" 
args       = arg | arg "," args 
arg        = id | quoted-string | integer | float | URL 
id         = 1*<any CHAR except CTLs or SP> [ array-dim ]
\end{vcode}

The \CE MUST be encoded using US-ASCII characters. It MAY be used when
requesting the DDS or DataDDS ({\it i.e.} when using the \lit{dds} or
\lit{dods} extensions, see~\Sectionref{sec-dods}). It MAY NOT be used with
the DAS, Version or Help Requests. When it is included in a request, it MUST
appear in the request URL as described in~\Sectionref{sec-url-syntax}. Note
that a \CE is optional for both the DDS and DataDDS requests; if absent the
request is for the entire contents of the data source.

A \CE has two parts, the projection and the selection. A projection lists
the variables to be returned by the \DAP server. If more than one
variable is to be returned, then the projection is a comma-separated list of
variables. Leaving the projection part of the \ac{CE} empty is shorthand for
requesting all the variables in the data source. A selection is used to
request that variables, or instance of variables in the case of a \Sequence,
are returned only if they match certain values. Either or both the projection
and selection part of the \CE MAY be null.

\paragraph{Identifier names}
The encoding rules for identifier names are given in \Sectionref{sec-names}. A 
valid identifier name MUST appear for \lit{id} in the above grammar. To
refer to one field of a constructor type, set \lit{id} to the name of the
constructor, followed by a period (\lit{.}) and the field name. To request
all of the fields in a constructor, set \lit{id} to the name of the
constructor. The \lit{id} value is case-sensitive: the string \lit{temp} is
different than the string \lit{Temp}.

\paragraph{Hyperslab operators}
An \Array MAY be accessed using only its name to return the entire array or
using a hyperslab (\lit{[]}) operator to return a rectangular section of
the array. In the later case, the hyperslab is defined for each dimension by
a starting index, an ending index, and an optional stride value. An \Array or
\Grid variable MUST either be unconstrained or have a hyperslab constraint for
each of its dimensions. Note that it is possible to combine the syntax that
requests a field of a constructor with the \Array hyperslab syntax to request
a section of one of the \Array variables held in a \Grid.

\begin{vcode}{cft}
array-dim = [ start ":" stride ":" stop ] 
            [ start ":" stop ] 
            [ start ] 
start, stride, stop = 1*DIGIT 
\end{vcode}

The omitted \lit{stride} value indicates a default of one.  If the
\lit{stop} is also omitted, its default value is the same as the
\lit{start} value.  All of these must be integers greater than or
equal to zero.

\paragraph{Calling server-side functions}
Functions MAY be called as part of either the projection or selection
clauses. In the case of a selection, the function MUST return a value which
can be used when evaluating the clause. In the case of a projection, the
function MUST return a \DAP variable which will then be the return value of
the request or it MUST return nothing in which case it is run for side effect
only. 

\begin{vcode}{cft}
selection = *relation | *function 
relation  = (id rel-op id) | (value rel-op id) 
            | (id rel-op value) 
value     = constant | ( "{" 1#constant "}" ) 
constant  = quoted-string | <int> | <float> | URL 
\end{vcode}

\paragraph{Syntax errors}
Syntax errors in the \CE MUST cause an Error response to be returned. The
Error response SHOULD contain text that describes the error. The description
SHOULD be human readable.

\subsection{Request Headers}

The headers described in Sections~\ref{sec-accept-encoding}
to~\ref{sec-user-agent} MUST be handled as described. Other headers which
are part of \ac{HTTP} 1.1 MAY be included in the request and MAY be honored
by a \DAP server.

\subsubsection{Accept-Encoding}
\label{sec-accept-encoding}
The \lit{Accept-Encoding} request-header is used by a \DAP client to
tell a server that it can accept compressed responses. See RFC
2616\cite{rfc2616} for this header's grammar. Values for encodings
are \lit{deflate}, \lit{gzip} and \lit{compress}. This header is
OPTIONAL. When a client includes this header it is effectively asking
the \DAP server to encode the response using the given scheme. The
server is under no obligation to use the requested encoding. Note that
as per Section~\Sectionref{content-encoding}, a server MUST use the
\lit{Content-Encoding} header to indicate that a content encoding has
been applied. A server MUST NOT use an encoding when a client has not
requested it.

\subsubsection{Host}
\label{sec-host}
The \lit{Host} request-header is used by a \DAP client to provide the 
DNS name or IP address of the \DAP server. See RFC 2616\cite{rfc2616}
for this header's grammar. This header MUST be included with every request.

\subsubsection{User-Agent}
\label{sec-user-agent}
The \lit{User-Agent} request-header is used by a \DAP client to
provide specific information about the client software to the \DAP
server. See RFC 2616\cite{rfc2616} for this header's grammar. This header is
RECOMMENDED. \DAP servers MAY log this information.

\subsection{Conditional Requests}
\label{sec:conditional-requests}

The \DAP supports HTTP/1.1 conditional requests made using the
\lit{If-Modified-Since} header. \DAP servers SHOULD honor this header
and return an HTTP/1.1 result code of 304 (Not Modified) if
appropriate. 

While HTTP/1.1 supports both date-based (using the \lit{Last-Modified}
header) and entity-based (using the \lit{ETag} header) conditional
requests, the \DAP only supports the date-based ones. For many data
sources, computing the values for \lit{ETag} headers would be onerous.

See RFC~2616\cite{rfc2616} for the description of
conditional GET requests.

\section{Responses}
\label{sec-responses}

A valid \DAP response has the same form as a valid \ac{HTTP} response. The
first line contains the \ac{HTTP} protocol version, a status code and reason
phrase\cite{rfc2616}. Following this are the response headers which vary
depending on the request and payload of the response
(see~\Sectionref{sec-resp-headers} for a description of the headers). As
described in RFC~822\cite{rfc822}, the \ac{HTTP} response status line and
headers are separated from the response's payload by an extra set of
CRLF\footnote{The token `CRLF' is used to denote the carriage return and
  linefeed characters which correspond to decimal value 10 and decimal vale
  13.} characters which make a blank line.

The six possible response payloads defined by the \DAP are described
in detail in~\Sectionref{sec-resp-bodies}.

\subsection{Response Headers}
\label{sec-resp-headers}

The \DAP responses use several of the standard MIME headers, in
addition to some \DAP-specific headers.

\subsubsection{Content-Description}
The \lit{Content-Description} header is used to tell clients which of the
different basic responses is being returned or if an error message is being
returned. For any of the basic responses (\ac{DDS}, \ac{DAS}, or
\ac{DataDDS}) or the error response, this header MUST be included. This
header MUST NOT be included in Version or Help responses. See
IETF~RFC~2045\cite{rfc2045} for information about this header.

\begin{vcode}{cft}
Content-Description = "Content-Description :" tag 
tag                 = "dods-dds" | "dods-das" | "dods-data" | "dods-error" 
\end{vcode}

Example:
\begin{vcode}{ct}
Content-Description: dods-error
\end{vcode}

\subsubsection{Content-Encoding}
\label{content-encoding}
If a \DAP server applies an encoding to an entity, it MUST include the
\lit{Content-Encoding} header in the response. See RFC~2616\cite{rfc2616}
for this header's grammar.

Example:
\begin{vcode}{ct}
Content-Encoding: deflate
\end{vcode}

\subsubsection{Content-Type}
The \lit{Content-Type} header MUST be included in any response from a
\DAP server. Valid content types for \DAP responses are:
\lit{text/plain}, \lit{text/html} and
\lit{application/octet}.\footnote{It would be better to use a multipart
  document in place of the \lit{application/octet}.} See RFC~2616\cite{rfc2616} for this header's grammar.

Example:
\begin{vcode}{ct}
Content-Type: application/octet
\end{vcode}

%% Add support for all the related caching headers. jhrg 12/14/04

\subsubsection{Support for HTTP/1.1 caching}
\label{sec-http-caching}

In order to support HTTP/1.1 caching, either in the client or in a
separate client-side cache sub-system, the \DAP must includ two
headers in each response: \lit{Date} and \lit{Last-Modified}. Other
headers such as \lit{Expires}, \lit{Cache-Control} and \lit{Vary} are
useful but not essential. 

While not required by the \DAP, the \lit{Expires} header is
none-the-less important. Because programs may download the structure
(DDS), attributes (DAS) and data (DataDDS) as separate requests and at
separate times, a cache may pick significantly different expiration
times in the absence of an explicit Expires header. Data sources that
are frequently updated will have \DAP component requests that cache
and expire together if the Expires header is explicitly (and
correctly) set.\footnote{Thanks to Benno Blumenthal for pointing this
  out and for providing this text, which was changed slightly,
  hopefuly without introducing any error.}

See the HTTP/1.1 RFC~2616\cite{rfc2616} for
more information about HTTP's support for caching.

\paragraph{Date}
The \lit{Date} header provides a time stamp for the response. This header
is needed for servers that support caching. See RFC~2616\cite{rfc2616}
for this header's grammar. Servers MUST provide this header.

Example:
\begin{vcode}{ct}
Date: Fri, 09 Feb 2001 18:54:55 GMT
\end{vcode}

\paragraph{Last-Modified}
The \lit{Last-Modified} header provides the time that the response
last changed. This should be the most recent of the last time the data
set changed and the last time the server changed. 

Example:
\begin{vcode}{ct}
Last-Modified: Mon, 05 Feb 2001 18:54:55 GMT
\end{vcode}

%% \subsubsection{Keep-Alive}
%% A \DAP server (or an underlying \ac{HTTP} server if one is used to
%% implement the \DAP server) MAY return a \lit{Keep-Alive} header for an
%% authenticate (code 401) response. For all other responses, the \DAP
%% server MUST NOT return this header.\footnote{This is a shortcoming of the
%%   \DAP. It should support HTTP/1.1's persistent connections. However, to
%%   do requires that the responses also return Content-Length. Since none of our
%%   servers do this, I've got no experience with persistent connections.} See
%% RFC 2616~\cite{rfc2616} for this header's grammar.

\subsubsection{Server}
The \lit{Server} header provides information about the server used to
process the request. In this case the \emph{server} MAY be either the
\DAP server or an underlying \ac{HTTP} server if the \DAP server uses
that as part of its implementation. See RFC~2616\cite{rfc2616}
for this header's grammar. This header is OPTIONAL.

Example:

\begin{vcode}{ct}
Server: Apache/1.3.12 (Unix)  (Red Hat/Linux) PHP/3.0.15 mod_perl/1.21
\end{vcode}

\subsubsection{WWW-Authentication}
The \lit{WWW-Authenticate} header MUST be included in an HTTP message
that has a response code of 401. That is, when the \DAP server is
asked to provide access to a resource that is restricted and the
request does not include authentication information (see ``HTTP
Authentication: Basic and Digest Access
Authentication''\cite{rfc2617}). then it must return with a response
code of 401 and include the \lit{WWW-Authenticate} header. See
RFC~2616\cite{rfc2616} for this header's grammar.

Example:

\begin{vcode}{ct}
WWW-Authenticate: Basic realm="special directory, with CGIs"
\end{vcode}

\subsubsection{XDODS-Server}

The \lit{XDODS-Server} header is used to return \DAP server's
implementation version information to the client program.\footnote{The
  version information should be changed to reflect the version of the
  \DAP.} This header MUST be included in every response.

\begin{vcode}{cft}
XDODS-Server = "XDODS-Server : dods/" version 
version      = DIGIT . DIGIT [ . DIGIT ]
\end{vcode}

Example:
\begin{vcode}{ct}
XDODS-Server: dods/3.2.2
\end{vcode}

\subsection{Response Bodies}
\label{sec-resp-bodies}

There are several responses that can come from a server, but four of them are
the core functionality of the system. The DAS, the DDS, and the DataDDS can
be thought of as data objects containing representations of the data source's
semantic metadata ({\it i.e.} attributes), its syntactic metadata
(structure), and its data, respectively. The Error response MUST ONLY be used
to signal problems with a request.

\subsubsection{DAS}
\label{sec-das}

\begin{center}
  \begin{tabular}[l]{ll}
    URL Extension & \lit{das} \\
    Headers & \lit{Content-Description: dods-das} \\
                     & \lit{Content-Type: text/plain} \\
                     & \lit{Server:} \\
                     & \lit{Date:} \\
                     & \lit{Last-Modified:} \\
                     & \lit{XDODS-Server:} \\
  \end{tabular}
\end{center}

The \ac{DAS} response is returned as the payload of a message which MUST have
\lit{dods-das} as the value of \lit{Content-Description} and \lit{text/plain}
as the value of \lit{Content-Type}. The body of the response contains the
persistent representation of the DAS object.

%% The \ac{DAS} is used to store attributes for both the entire data source and
%% variables in the data source. The \ac{DAS} consists of a number of
%% \emph{containers} each of which hold zero or more attributes. Each attribute
%% is a name-datatype-value tuple. Values may be either scalar or vector. Note
%% that two, three, \ldots, dimensional attribute values are \emph{not}
%% supported.  The name of an attribute container MUST be the same as
%% the name of the variable to which its attributes refer.

A \ac{DAS} MUST have a container for each variable in the data source. The
hierarchy of containers in a DAS MUST follow the hierarchy of constructor
types in the DDS. It MAY contain any number of extra containers.

\begin{vcode}{cft}
das-doc        = "Attributes" "{" *attribute-cont "}"
attribute-cont = attribute-cont | attribute 
attribute      = atomic-decl id 1#value *values ";"
values		   = "," value
value          = <float> | <int> | id | quoted-string 
\end{vcode}

%% The purpose of attributes is to hold additional information beyond the name,
%% datatype and value of a variable and/or to hold extra information about a
%% data source as a whole. This extra information can make the contents of the
%% data source much easier to use. For example, extra information contained in the
%% \ac{DAS} might provide unit names, scaling factors or the missing-value
%% values. Additional information about an entire data source might contain
%% information about who collected the information, under what circumstances
%% \emph{et cetera}. 

%% Many systems rely on attributes to store extra information that is necessary
%% to perform certain manipulations with data. In effect, attributes are used to
%% store information that is used `by convention' rather than `by design'.
%% The \DAP can effectively support these conventions by passing the attributes
%% from data set to user program via the \ac{DAS}. Of course, the \DAP cannot
%% enforce conventions in data sets where they were not followed in the first
%% place.

%% \paragraph{Encoding attribute values} Attribute values are encoded as
%% strings. Those values are returned as part of the DAS response. 

\paragraph{Encoding Atomic types} Atomic-type attributes are encoded as
follows: Each attribute has a print representation that consists of the type
name followed by the attribute name followed by the value or values. The
print representation of the value(s) is determined according to:

\begin{enumerate}
\item Integers: Each integer value is printed using the base 10 ASCII
  representation of its value.
\item Floating point: Each floating point value is printed using the base 10
  ASCII representation of its value. The ouput MUST conform to ANSI \C's
  description of \lit{printf} using the \lit{\%g} format specification and
  the precision is 6.
\item String and URL: Strings and URLs are printed in US-ASCII. If the value
  of a string contains a space, it must be quoted using double quotes
  (\lit{"}). If the value contains a double quote, that MUST be escaped using
  the backslash ($\backslash$) character. The backslash character is
  represented as backslash-backslash ($\backslash\backslash$).
\end{enumerate}

\paragraph{Encoding attribute structures} Attribute Structures are encoded
  by printing the name of the Structure, followed by a curly brace
  (\lit{\{}), followed by the print representation of all its child
  attributes followed by a closing curly brace (\lit{\}}).

%% Unlike the DDS/DataDDS response pair, there is no way to constrain a request
%% for the information returned in the DAS response. When a data source returns
%% attribute information, it returns the values of \emph{all} of its
%% attribtues.
%% This is acceptable because, while there is overlap in the range of values
%% that can be stored in attributes, the intent is that attributes will store a
%% volume of data many many times smaller than will be stored by the variables
%% inthe DDS/DataDDS. 

An example \ac{DAS} is shown in \Figureref[Figure 6]{fig-das}.

\begin{figure}
\begin{vcode}{cb}
attributes {
   catalog_number {
   }
   casts {
      experimenter {
      	 string names "Flierl", "Hankin", "Sgouros", "Potter", "Gallagher";
      }
      time {
         string units "hour since 0000-01-01 00:00:00";
         string time_origin "1-JAN-0000 00:00:00";
      }
      location {
         lat {
            string long_name "Latitude";
            string units "degrees_north";
         }
         lon {
            string long_name "Longitude";
            string units "degrees_east";
         }
      }
      xbt {
         depth {
            string units "meters";
         }
         t {
            float32 missing_value -9.99999979e+33;
            float32 _Fillvalue -9.99999979e+33;
            string history "From coads_climatology";
            string units "Deg C";
         }
      }
   }
}
\end{vcode}

\caption[Example Dataset Attribute Response.]{Example Dataset
  Attribute Response. This example corresponds to the DDS shown in
  Figure~\ref{fig-dds}. Some of the variables in this fictional data
  source ({\it e.g.} \lit{catalog\_number}) have no attributes. Even
  though they lack attributes, they still have a matching \Attribute
  \Structure. Note: The attributes shown in the example are \emph{not}
  part of \DAP. In this particular example, most of the attributes'
  semantics are defined by the COARDS convention. The \_Fillvalue
  attribute, however, is from NCL\cite{NCL} (the leading underscore
  instructs NCL to substitute this value for any missing values).
  Neither COARDS nor NCL are part of the the \DAP. The \DAP \Attribute
  can be used to hold any attribute information that can be stored
  using the Atomic types, vectors of atomic types and structures
  composed of those (vector and scalar) types.}

\label{fig-das}
\end{figure}

% \addtocounter{footnote}{-1} 

% \footnotetext{}

\subsubsection{DDS}
\label{sec-dds}
\begin{center}

  \begin{tabular}[l]{ll}
    URL Extension & \lit{dds} \\
    Headers & \lit{Content-Description: dods-dds} \\
                     & \lit{Content-Type: text/plain} \\
                     & \lit{Server:} \\
                     & \lit{Date:} \\
                     & \lit{Last-Modified:} \\
                     & \lit{XDODS-Server:} \\
  \end{tabular}
\end{center}

The \ac{DDS} response is returned as the payload of a message which MUST have
\lit{dods-dds} as the value of \lit{Content-Description} and \lit{text/plain}
as the value of \lit{Content-Type}. The body of the response contains the
persistent representation of the \ac{DDS} object.

The DDS is a textual description of the variables and their names and types
that compose the entire data set. The data set descriptor syntax is similar
to the variable declaration/definition syntax of {\small C} and \Cpp. A
variable that is a member of one of the base type classes is declared by
writing the class name followed by the variable name. The type constructor
classes are declared using {\small C}'s brace notation.

\begin{vcode}{cft}
dds-doc   = "data-source" "{" *type-decl "}" id ";" 
type-decl = atomic-decl  | array-decl 
            | structure-decl | sequence-decl | grid-decl 
\end{vcode}
        
The \lit{dataset} keyword has the same syntactic function as \lit{structure}
but is used for the specific job of enclosing the entire data source even
when it does not technically need an enclosing element (because at the
outermost level it is a single element such as a structure or sequence).

An example DDS is shown in \Figureref[Figure 7]{fig-dds}.

\begin{figure}
\begin{vcode}{cb}
dataset {
   int catalog_number;
   sequence {
      string experimenter;
      int32 time;
      structure {
         float64 latitude;
         float64 longitude;
      } location;
      sequence {
         float depth;
         float temperature;
      } xbt;
   } casts;
} data;
\end{vcode}
\caption{Example Dataset Descriptor Response.}
\label{fig-dds}
\end{figure}

Variables in the \DAP have two forms. They are either atomic types or
constructor types.

%% Constructor variables describe the grouping of one or more variables or values
%% within a data set. These variables are used to describe different types of
%% relations between the variables that comprise the data set. There are five
%% classes of type constructor variables defined by the \DAP: lists, arrays,
%% structures, sequences, and grids, described below.


\paragraph{Atomic variables}
Atomic variables are similar to predefined variables in procedural
programming languages like C or Fortran ({\it e.g.}, \texttt{int} or
\texttt{integer*4}).

\begin{description}
\item [byte] an 8-bit byte; unsigned char in ANSI C\@.
\item [int16] a 16-bit signed integer.
\item [uint16] a 16-bit unsigned integer.
\item [int32] a 32-bit signed integer.
\item [uint32] a 32-bit unsigned integer.
\item [float32] the IEEE 32-bit floating point datatype (ANSI C's
  \texttt{float}). 
\item [float64] the IEEE 64-bit floating point datatype (ANSI C's
  \texttt{double}) .
\item [string] a sequence of bytes terminated by a null character.
\item [URL] represented as a string, but may be dereferenced in a \ac{CE};
  see~\Sectionref{sec-ce}.
\end{description}

\begin{vcode}{cft}
atomic-decl = atomic-type id ";" 
atomic-type = "Byte" | "Int16" | "UInt16" | "Int32" | "UInt32" 
                 | "Float32" | "Float64" | "String" | "Url" 
id          = (ALPHA | "_" | "%" | "." ) 
              *(ALPHA | DIGIT | "/" | "_" | "%" | "." ) 
\end{vcode}
     
%% I've remove List since it is not implemented and since the same
%% representation can be achieved using a one-element sequence. 05/20/04 jhrg
%%
%% \paragraph{List}
%% \label{sec-list}

%%  The \textbf{List} type constructor is used to hold lists of 0 or
%%   more items of one type. Lists of \texttt{byte}, \ldots, \texttt{grid} are
%%   specified using the keyword \texttt{list} before the variable's class. The
%%   list can be of any type \textbf{except \texttt{List}}.

%% \begin{ttfamily}
%% \begin{center}
%% \begin{tabular}{lll}
%% \var{list-decl} & = & list (\var{simple-decl}  | \var{array-decl} | \var{structure-decl} \\
%%           & & | \var{sequence-decl} | \var{grid-decl}) \\
%% \end{tabular}
%% \end{center}
%% \end{ttfamily}

%% Examples:
%% \begin{quote}
%% \begin{vcode}{t}
%% list int32 heights;
%% List Float64 x[10][10];
%% \end{vcode}
%% \end{quote}

\paragraph{Array}
An \textbf{Array} is a one dimensional indexed data structure similar
to those defined by
ANSI \C. Multidimensional arrays are defined as arrays of arrays. The size of
each array's dimensions must be given. Each dimension of an array may also be
named.

%% Multi-dimensional arrays are stored in row-major order (as is
%% the case with ANSI \C or \Cpp). Any array stored in row-major order is stored
%% so that the last dimension varies most quickly. For example suppose the two
%% dimensional array \texttt{String letter[2][3]} has two rows of three columns
%% each and looks like:
%% \begin{displaymath}
%% \begin{array}{ccc}
%% A & B & C \\
%% D & E & F \\
%% \end{array}
%% \end{displaymath}
%% the values would be stored as $A~B~C~D~E~F$ in memory.

% Define whether multi-dimensional arrays are row-major or not.  Don't
% use the phrase ``row-major'' without also giving an example; people
% don't ever remember which is which.  (Except perhaps for you.)
\begin{vcode}{cft}
array-decl  = array-types id array-dims ";" 
array-types = atomic-decl | structure-decl | sequence-decl | grid-decl 
array-dims  = array-dim | array-dim array-dims 
array-dim   = "[" [ name "=" ] 1*DIGIT "]" 
\end{vcode}

The number of dimensions MUST be greater than zero.

\paragraph{\Structure}
 A structure groups variables so that the collection can be
  manipulated as a single item. The variables can be of any type.

\begin{vcode}{cft}
structure-type  = structure "{" *structure-types "}" ";" 
structure-types = atomic-type | array-type 
                  | structure-type | sequence-type | grid-type 
\end{vcode}
              
\paragraph{Sequence}
 A sequence is an ordered set of $N$ variables which has
  several instantiations ({\it i.e.} values). Variables in a sequence may be of
  different types.  Each instance of a sequence is one instantiation of the
  variables. Thus a sequence can be represented as:

\begin{displaymath}
\begin{array}{ccc}
  s_{0 0} & \cdots & s_{0 n} \\
  \vdots & & \vdots \\
  s_{i 0} & \cdots & s_{i n}
\end{array}
\end{displaymath}

\noindent Every instance of sequence $S$ has the same number, order,
and type of variables. Thus in a sequence which contains an array,
each instance of the array MUST be the same size. A sequence implies
that each of the variables is related to each other in some logical
way. A sequence is different from a structure because its constituent
variables have several instances while a structure's variables have
only one instance. A Sequence may contain one Sequence as a child
element (which may itself also contain one child Sequence, and so
on).\footnote{Current use always places the inner sequence last in the
  child variables, and since existing software may depend on this,
  that practice has been codified in the grammar.}
\label{sequence-grammar}

\begin{vcode}{cft}
sequence-decl  = sequence "{" *sequence-types [sequence-type] "}" ";" 
sequence-types = atomic-type | array-type 
                 | structure-type | grid-type 
\end{vcode}

\paragraph{\Grid}
\label{sec-grid}
 A grid is an association of an $N$ dimensional array with $N$
  named vectors, each of which has the same number of elements as the
  corresponding dimension of the array. Each vector is used to map indices of
  one of the array's dimensions to a set of values which are normally
  non-integral ({\it e.g.} floating point values). The $N$ (map) vectors may be
  different types. \Grids are similar to arrays, but add named dimensions and
  maps for each of those dimensions.

\begin{vcode}{cft}
grid-decl = "Grid" "{" "Array:" array-decl "Maps:" 1*array-decl "}" ";" 
\end{vcode}


\subsubsection{DataDDS}
\label{sec-dods}

\begin{center}
  \begin{tabular}[l]{ll}
    URL Extension & \lit{dods} \\
    Headers & \lit{Content-Description: dods-data} \\
                     & \lit{Content-Type: application/octet} \\
                     & \lit{Server:} \\
                     & \lit{Date:} \\
                     & \lit{Last-Modified:} \\
                     & \lit{XDODS-Server:} \\
  \end{tabular}
\end{center}

This response body returns data to the client. It consists of a copy
of the \ac{DDS}, followed by data in its external representation,
described in~\Sectionref{sec-rep-of-values}.

The \ac{DataDDS} entity is returned as the payload of a message whose
\lit{Content-Type} header MUST be \lit{application/octet}. The body of
the response contains both text, which holds a \ac{DDS} describing the
variables listed in the response and the values for those variables
encoded using XDR\cite{xdr}. The literal \lit{Data:} is used to
separate the text \ac{DDS} and the binary data.

\begin{vcode}{cft}
DataDDS = DDS CRLF "Data:" CRLF *OCTET
\end{vcode}

Clients MAY supply a constraint expression (see~\Sectionref{sec-ce}) with
any \lit{DataDDS} request. The \ac{DDS} in the \lit{DataDDS} response
describes the variables returned. The order that the variables are listed in
the \ac{DDS} MUST match the order of the values in the binary section of the
\ac{DataDDS} response. If the response contains constructor types, then the
variables are sent in the order they would be visited in a depth-first
traversal of the accompanying \ac{DDS}.

The DDS is included in this response to provide a description of the
binary data so that a program will know which values, their size and
order, are included in a response.\footnote{One possible design would
  instantiate a DDS object using this information and then read values
  into objects representing the variables.}

\subsubsection{Error}
\label{sec-error}

\begin{center}
  \begin{tabular}[l]{ll}
    URL Extension & n/a \\
    Headers & \lit{Content-Description: dods-error} \\
                     & \lit{Content-Type: text/plain} \\
                     & \lit{Server:} \\
                     & \lit{Date:} \\
                     & \lit{Last-Modified:} \\
                     & \lit{XDODS-Server:} \\
  \end{tabular}
\end{center}

When a server encounters an error in the client's request it MUST
return an Error response. When an error is encountered in the server's
own software it SHOULD return an Error. The body of the Error response
contains an error code along with text that provides a description of
the problem encountered. Server writers are encouraged to provide text
that describes the problem with enough information to enable a user to
correct the problem or submit a meaningful bug report to the server's
maintainer.

\begin{vcode}{cft}
Error      = "Error" "{" "code=" error-code ";" 
                         "message=" error-msg ";" "}" 
error-code = 1*DIGIT 
error-msg  = quoted-string 
\end{vcode}

\subsubsection{Version}
\label{sec-version}

\begin{center}
  \begin{tabular}[l]{ll}
    URL Extension & {\it none} \\
    Headers & \lit{Content-Type: text/plain} \\
                     & \lit{Server:} \\
                     & \lit{Date:} \\
                     & \lit{Last-Modified:} \\
                     & \lit{XDODS-Server:} \\
  \end{tabular}
\end{center}

The \lit{version} response returns information about the \DAP version,
server version and may return information about a data source's version. The
response may be requested in two ways: by using the string \lit{version}
as the \lit{data-source-id} or by appending the extension
\lit{ver} to the data source name (see~\Sectionref{sec-url-syntax}). 

\begin{vcode}{cft}
abs-path       = server-path data-source-id [ "." ext [ "?" query ] ] 
ext            = ".ver"
server-path    = <name of DAP server> 
data-source-id = "version" 
\end{vcode}

If a \DAP server receives a \lit{version} request, it MUST return \DAP
version information and SHOULD return server version information. If
the request is made using the \lit{ver} extension to a
\lit{data-source-id} then, in addition to the information returned for
the \lit{version} case, it MAY also return a data source version.

Version information should be returned as plain text in the payload of the
response. This version information may be essentially the same as the
information in the XDODS-Server header. The intent is to present users and
system maintainers with information about servers that can be used to track
down problems or determine if a server can be upgraded to a newer version to
fix a particular problem.

\begin{vcode}{cft}
version-response    = dap-version CRLF server-version 
                       [ CRLF data-source-version ] 
dap-version         = "Core version:" token "/" version-number 
server-version      = "Server version:" token "/" version-number 
data-source-version = "Dataset version:" token "/" version-number 
token               = 1*<any CHAR except CTLs or separators> 
version-number      = 1*DIGIT "." 1*DIGIT "." 1*DIGIT 
\end{vcode}

\subsubsection{Help}
\label{sec-help}

\begin{center}
  \begin{tabular}[l]{ll}
    URL Extension & n/a \\
    Headers & \lit{Content-Type: text/html} \\
                     & \lit{Server:} \\
                     & \lit{Date:} \\
                     & \lit{Last-Modified:} \\
                     & \lit{XDODS-Server:} \\
  \end{tabular}
\end{center}

The \lit{help} response MUST be returned when either the server receives a
\ac{URL} with no extension ({\it i.e.}, a \ac{URL} which asks for no object) or
when the \lit{data-source-id} portion of the \ac{URL} is \lit{help}.

\begin{vcode}{cft}
abs-path       = server-path data-source-id [ "." ext [ "?" query ] ] 
server-path    = <name of DAP server> 
data-source-id = "help" 
\end{vcode}

The second way of requesting the \lit{help} response is analogous to 
requesting the \lit{version} response.

The \lit{help} response MUST return an ASCII document which lists
the extensions recognized by the server. The response MAY return other
information as well.

\subsection{Encoding Values}
\label{sec-rep-of-values}

% Explicit description of how XDR encodes types.
  
This section describes the external (persistent) representation of
values held by a \DAP Data Source. This is the way the variables are
encoded for inclusion in the \ac{DataDDS} (see \Sectionref{sec-dods}).
This specification should not be understood to dictate the storage of
variables in a \DAP client or server, in memory or on the disk. What a
client does with this data is beyond the scope of this specification,
which is only concerned with communicating the values from server to
client.

From the point of view of the external representation, it is useful to
divide the constructor types into aggregate types and array types,
making---with the atomic types---three basic types of \DAP variables.

\subsubsection{Atomic types}
\label{sec-rep-of-simple}

The \DAP uses Sun Microsystems' XDR protocol\cite{xdr} for the external
representation of all of the atomic type variables. \Tableref[Figure 8]{tab:base-xdr}
shows the XDR types used to represent the various atomic type
variables.

\xmlattributes*{table}{border="1"}
\begin{table}
\caption{The XDR data types used by the \DAP as the external representations
  of simple-type variables}
\label{tab:base-xdr}
\begin{center}
\begin{tabular}{ll} 
\multicolumn{1}{c}{\tblhd{Type}} & \multicolumn{1}{c}{\tblhd{XDR Type}} \\
\hline
\lit{Byte} & \lit{xdr byte} \\ \hline
\lit{Int16} & \lit{xdr short} \\ \hline
\lit{UInt16} & \lit{xdr unsigned short} \\ \hline
\lit{Int32} & \lit{xdr long} \\ \hline
\lit{UInt32} & \lit{xdr unsigned long} \\ \hline
\lit{Float32} & \lit{xdr float} \\ \hline
\lit{Float64} & \lit{xdr double} \\ \hline
\lit{String} & \lit{xdr string} \\ \hline
\lit{URL} & \lit{xdr string} \\ \hline
\end{tabular}
\end{center}
\end{table}

\subsubsection{Constructor types}

In order to transmit constructor type variables, the \DAP defines how the
various base type variables, which comprise the constructor type variable,
are transmitted. Any constructor type variable may be subject to a constraint
expression which changes the amount of data transmitted for the variable
(see~\Sectionref{sec-ce}). For each of the four constructor types these
definitions are:

\paragraph{Array}
\label{par:array}

An array is first sent by sending the number of elements in the array,
twice for atomic types (Byte, Int16, UInt16, Int32, UInt32, Float32,
Float64), and once for the constructor types.\footnote{This is an
  artifact of the first implementation of the \DAP and XDR. The \DAP
  software needed length information to allocate memory for the array
  so it sent the array length. However, XDR also sends the array
  length for its own purposes. The demands of backward compatibility
  have left it in current implementations.} The array lengths are
32-bit integers encoded as \lit{xdr\_long} would encode
them.\footnote{Note that this means that array lengths are limited to
  $2^{31}-1$ elements.}

  Following the length information, each array element is encoded in
  succession. Arrays of bytes are handled differently than other arrays:
\begin{enumerate}
\item An array of bytes: Bytes are encoded as the function xdr\_byte()
  encodes an array of bytes. The order of bytes is retained regardless
  of the endian nature of the source. Arrays of bytes, not individual
  bytes, are padded to four byte boundries. Thus an array of 10 bytes
  is padded to 12 bytes.
  
\item One-dimensional arrays of all types other than \lit{byte} are
  encoded by encoding each element of the array in the order they
  appear. Note that atomic types are encoded as XDR would encode an
  array. Constructor types are encoded by individually encoding each
  value as described in this section.\footnote{This means that while
    just about every array type remains the same size once encoded,
    an array of 16-bit integers doubles in size because XDR encodes
    16-bit integers as 32-bit integers. Note that byte arrays are a
    special case, individual bytes are {\it not} padded; instead the
    entire array is padded. For a more deatiled description of XDR's
    operation, see RFC~1014\cite{xdr}.}

\item Multi-dimensional arrays are encoded by encoding the elements
  using row-major ordering. Atomic types are encoded as XDR would
  encode an array. Constructor types are encoded by individually
  encoding each value as described in this section.

\end{enumerate}

\begin{vcode}{cft}
Array        = atomic-array | ctor-array
atomic-array = length length values 
ctor-array   = length values 
length       = <32-bit integer, signed, big endian> 
values       = bytes | other-values 
bytes        = <8-bit bytes padded to a four-byte boundary> 
other-values = numeric-values | strings | aggregates 
\end{vcode}

%% Removed List. 05/20/04 jhrg
%%
%% \paragraph{List}
%% A list is sent as if it were an array. Even though the length of
%%   a list is not declared, at the time the list's value(s) are to be sent, its
%%   length must be known. Thus it is possible to think of a list as a vector of
%%   values and hence use the same encoding for those values as would be used
%%   for an equivalent array.

\paragraph{\Structure}
A structure is sent by encoding each field in the order
  those fields are declared in the structure. For example, the structure:

\begin{vcode}{it}
Structure {
    int32 x;
    float64 y;
} a;
\end{vcode}

Would be sent by encoding the int32 \lit{x} and then the float64
\lit{y}. 

Nested structures are sent by encoding their `leaf nodes' as visited in a
depth first traversal. For example:

\begin{vcode}{it}
Structure {
    int32 x;
    Structure {
        String name;
        Byte image[512][512];
    } picture;
    float64 y;
} a;
\end{vcode}

Would be sent by encoding \lit{x}, then \lit{name}, \lit{image} and
finally \lit{y}.

\paragraph{\Sequence}
\label{par:sequence}

A Sequence is transmitted by encoding each instance as for a structure and
sending one after the other, in the order of their occurrence in the data
set. The entire sequence is sent, subject to the constraint expression. In
other words, if no constraint expression is supplied then the entire sequence
is sent. However, if a constraint expression is given, only the records in the
sequence that satisfy the expression are sent

Because a sequence does \emph{not} have a length count, each instance is
prefixed by a \lit{start of instance} marker. Also, to accommodate nested
sequences, then end of each sequence as a whole is marked by a \lit{end of
sequence} marker.

\begin{vcode}{cft}
sequence      = instances end-of-seq 
instances     = start-of-inst instance-values 
end-of-seq    = <byte value 0xA5> 
start-of-inst = <byte value 0x5A> 
\end{vcode}

Since XDR is used to encode the binary data response, the
\lit{start of instance} and \lit{end of sequence} bytes must thus be
encoded using XDR. This means that these bytes are sent with three
additional bytes of padding as \lit{xdr\_byte} would encode them.

An empty \Sequence\footnote{A returned \Sequence might contain no values
  because it is accessed using a constraint which no element in the
  \Sequence satisfies.} is encoded by sending only the \lit{end-of-seq}
marker, encoded as \lit{xdr\_byte} would encode it. 

\paragraph{\Grid}
A \Grid is encoded as if it were a \Structure (one component after the other,
in the order of their declaration).

\section{Examples}

Following are some examples of requests sent to a server representing
some data source and the response documents returned by those
requests.

\subsection{Simple request}

Assume that a server called \lit{server.edu} has some temperature
data, stored as a ten-element array named \lit{Tmp}, in a single file
called \lit{temp.dat} in a directory called \lit{data} in the
\lit{htdocs} tree. A \DAP URL requesting the DDS might look like this:

\begin{vcode}{t}
http://server.edu/cgi-bin/nph-dods/data/temp.dat.dds
\end{vcode}

In all of the following examples, carriage returns and new lines are shown as
\lit{<CRLF>}. Only shown are the \lit{<CRLF>} characters that
are REQUIRED. Since some or all of each response is encoded as text, it makes
sense to include extra line breaks to enhance their readability (as we've
done here).

The document containing the DDS response would look like this:

\begin{vcode}{cft}
Content-Description: dods-dds<CRLF>
Content-Type: text/plain<CRLF>
Server: Server: Apache/1.3.12 (Unix)  PHP/3.0.15 mod_perl/1.21<CRLF>
Date: Fri, 09 Feb 2001 18:54:55 GMT<CRLF>
Last-Modified: Mon, 05 Feb 2001 16:50:02 GMT<CRLF>
XDODS-Server: Friendly-neighborhood DAP implementation v/3.1.1<CRLF>
<CRLF>
Dataset {
  Float32 Tmp[10];
} temp.dat;
\end{vcode}

Note that each of the response headers MUST end in a carriage-return
line-feed pair. Also note that a carriage-return
line-feed pair on an otherwise blank line MUST separate the response headers
from the message body\cite{rfc2045,rfc2046}.

The DAS would be requested like this:

\begin{vcode}{t}
http://server.edu/cgi-bin/nph-dods/data/temp.dat.das
\end{vcode}

And its response might look like this:

\begin{vcode}{ft}
Content-Description: dods-das<CRLF>
Content-Type: text/plain<CRLF>
Server: Server: Apache/1.3.12 (Unix)  PHP/3.0.15 mod_perl/1.21<CRLF>
Date: Fri, 09 Feb 2001 18:54:55 GMT<CRLF>
Last-Modified: Mon, 05 Feb 2001 16:50:02 GMT<CRLF>
XDODS-Server: Friendly-neighborhood DAP implementation v/3.1.1<CRLF>
<CRLF>
Attributes {
  Tmp {
    Float32 Lat 42.2;
    Float32 Lon -89.3
  }
}
\end{vcode}


The data would be requested like this:

\begin{vcode}{t}
http://server.edu/cgi-bin/nph-dods/data/temp.dat.dods
\end{vcode}

The DataDDS containing the data would look like this:

\begin{vcode}{ft}
Content-Description: dods-data<CRLF>
Content-Type: application/octet-stream<CRLF>
Server: Server: Apache/1.3.12 (Unix)  PHP/3.0.15 mod_perl/1.21<CRLF>
Date: Fri, 09 Feb 2001 18:54:55 GMT<CRLF>
Last-Modified: Mon, 05 Feb 2001 16:50:02 GMT<CRLF>
XDODS-Server: Friendly-neighborhood DAP implementation v/3.1.1<CRLF>
<CRLF>
Dataset {
  Float32 Tmp[10];
} temp.dat;<CRLF>
Data:<CRLF>
<Tmp length><Tmp length><value of Tmp[0]> ... <value of Tmp[9]>
\end{vcode}

Where \lit{<Tmp length>} (which appears twice) is the number (32-bit
 big-endian twos-compliment signed integer) of elements in the array. In this
 case it would be ten (\lit{00 00 00 0A}$_{16}$) and \lit{<value of Tmp[0]>},
 {\it et c.}, are the values (32-bit big endian IEEE 754 floating point).

Note that the \lit{Content-Type} header's value is
\lit{application/octet-stream} for this type of response and that the
character sequence \lit{<CRLF>Data:<CRLF>} serves as a separator for the
response DDS and the binary data values.

The binary data which follows the \lit{<CRLF>Data:<CRLF>} separator MUST
NOT contain any carriage-return line-feed pairs.

\subsection{\Grid}

Suppose you know that there's a 30 by 50 \Grid held in some data source at
\lit{server.edu}, and you want a 2 by 3 chunk of it. You can request a part of
a \Grid with a constraint expression like this: \lit{g[20:21][40:42]}.

\note{In the remaining examples, we will omit the explicit indication
  of carriage-return line-feed pairs to simplify presentation.}

Ask for the DDS of this data like this:

\begin{vcode}{t}
http://server.edu/cgi-bin/nph-dods/grid-data/temp2.dat.dds?g[20:21][40:42]
\end{vcode}

The document containing the DDS would look like this:

\begin{vcode}{ft}
Content-Description: dods-dds
Content-Type: text/plain
Server: Server: Apache/1.3.12 (Unix)  PHP/3.0.15 mod_perl/1.21
Date: Fri, 09 Feb 2001 18:54:55 GMT
Last-Modified: Mon, 05 Feb 2001 16:50:02 GMT
XDODS-Server: Friendly-neighborhood DAP implementation v/3.1.1

Dataset {
  Grid {
    Array:
      Float32 a[xdimen = 2][ydimen = 3]
    Maps:
      Float32 xdimen[xdimen = 2];
      Float32 ydimen[ydimen = 3];
  } g;
} temp2.dat;
\end{vcode}

The DAS would be requested like this:

\begin{vcode}{t}
http://server.edu/grid-data/temp2.dat.das?grid[20:21][40:42]
\end{vcode}

And its response might\footnote{We say `might' because there's no
  required set of attributes.} look like this:

\begin{vcode}{ft}
Content-Description: dods-das
Content-Type: text/plain
Server: Server: Apache/1.3.12 (Unix)  (Red Hat/Linux) PHP/3.0.15 mod_perl/1.21
Date: Fri, 09 Feb 2001 18:54:55 GMT
Last-Modified: Mon, 05 Feb 2001 16:50:02 GMT
XDODS-Server: Friendly-neighborhood DAP implementation v/3.1.1

Attributes {
  g {
    String Date "3 Nov 2003, 1433Z";
    String Instrument "Black & Decker Spectrum Analyzer";
  }
}
\end{vcode}


The data would be requested like this:

\begin{vcode}{t}
http://server.edu/cgi-bin/nph-dods/grid-data/temp2.dat.dods?g[20:21][40:42]
\end{vcode}

The DataDDS containing the data would look like this:

\begin{vcode}{ft}
Content-Description: dods-data
Content-Type: text/plain
Server: Server: Apache/1.3.12 (Unix)  PHP/3.0.15 mod_perl/1.21
Date: Fri, 09 Feb 2001 18:54:55 GMT
Last-Modified: Mon, 05 Feb 2001 16:50:02 GMT
XDODS-Server: Friendly-neighborhood DAP implementation v/3.1.1

Dataset {
  Grid {
    Array:
      Float32 a[xdimen = 2][ydimen = 3]
    Maps:
      Float32 xdimen[xdimen = 2];
      Float32 ydimen[ydimen = 3];
  } g;
} temp2.dat;
Data:
<g.a length><g.a length>
<g.a[0][0]><g.a[0][1]><g.a[0][2]>
<g.a[1][0]><g.a[1][1]><g.a[1][2]>
<g.xdimen length><g.xdimen length><g.xdimen[0]><g.xdimen[1]>
<g.ydimen length><g.ydimen length><g.ydimen[0]><g.ydimen[1]>
<g.ydimen[2]>
\end{vcode}

The data held in a \Grid type is encoded as for a \Structure, one field at a
time. In this example, first the \lit{g.a} field is encoded, then the
\lit{g.xdimen} and \lit{g.ydimen}

\subsection{\Sequence}

Suppose a Sequence of data called \lit{seq} is also stored at
\lit{server.edu}. Each record of the sequence contains three values:
\lit{xval}, \lit{yval}, and \lit{zval}. A constraint which asks for
all values of the \Sequence where \lit{xval} is less than fifteen
would look like:

\begin{vcode}{t}
xval<15
\end{vcode}

Ask for the DDS of these data like this:

\begin{vcode}{t}
http://server.edu/cgi-bin/nph-dods/seq-data/temp3.dat.dds?xval<15
\end{vcode}

The document containing the DDS would look like this:

\begin{vcode}{ft}
Content-Description: dods-dds
Content-Type: text/plain
Server: Server: Apache/1.3.12 (Unix)  PHP/3.0.15 mod_perl/1.21
Date: Fri, 09 Feb 2001 18:54:55 GMT
Last-Modified: Mon, 05 Feb 2001 16:50:02 GMT
XDODS-Server: Friendly-neighborhood DAP implementation v/3.1.1

Dataset {
  Sequence {
    Int16 xval;
    Int16 yval;
    Int16 zval;
  } seq;
} temp3.dat;
\end{vcode}

The DAS would be requested like this:

\begin{vcode}{t}
http://server.edu/cgi-bin/nph-dods/seq-data/temp3.dat.das?xval<15
\end{vcode}

And its response might look like this:

\begin{vcode}{ft}
Content-Description: dods-das
Content-Type: text/plain
Server: Server: Apache/1.3.12 (Unix)  PHP/3.0.15 mod_perl/1.21
Date: Fri, 09 Feb 2001 18:54:55 GMT
Last-Modified: Mon, 05 Feb 2001 16:50:02 GMT
XDODS-Server: Friendly-neighborhood DAP implementation v/3.1.1

Attributes {
  xval {
    String units "meters per second";
  }
  yval {
    String units "kilograms per minute";
  }
  zval {
    String units "tons per hour";
  }
}
\end{vcode}

The data would be requested like this:

\begin{vcode}{t}
http://server.edu/cgi-bin/nph-dods/seq-data/temp3.dat.dods?xval<15
\end{vcode}

The DataDDS containing the data would look like this:

\begin{vcode}{ft}
Content-Description: dods-data
Content-Type: text/plain
Server: Server: Apache/1.3.12 (Unix)  PHP/3.0.15 mod_perl/1.21
Date: Fri, 09 Feb 2001 18:54:55 GMT
Last-Modified: Mon, 05 Feb 2001 16:50:02 GMT
XDODS-Server: Friendly-neighborhood DAP implementation v/3.1.1

Dataset {
  Sequence {
    Int16 xval;
    Int16 yval;
    Int16 zval;
  } seq;
} temp3.dat
Data:
<0x5A><first xval><first yval><first zval>
<0x5A><next xval><next yval><next zval>
<0x5A><next xval><next yval><next zval>
<0x5A><last xval><last yval><last zval><0xA5>
\end{vcode}

A \Sequence's values are transmitted one instance at a time. Each instance is
prefixed by the \new{start of instance} marker which is \lit{5A}$_{16}$. In
this example, the constraint \lit{xval<15} causes four instances to be sent
and each one is prefixed by the start of instance marker. Once all of the
selected instances of the \Sequence have been sent, the \new{end of sequence}
marker (\lit{A5}$_{16}$) is written. 

\label{seq:2-level}
Here's a second example of a DataDDS request/response pair for a more complex
data source, one that has a \Sequence within a \Sequence. The DDS for this
data source looks like:

\begin{vcode}{ft}
Dataset {
  Sequence {
    Float32 lat;
    Float32 lon;
    Sequence {
      Int16 depth;
      Float64 temp;
    } sounding;
  } track;
} temp4.dat;
\end{vcode}

Suppose you wanted to get all the soundings in a lat/lon box that spans the
area of 80 to 90 degrees north latitude and 50 to 60 degress west longitude
(you would know the units of data source by looking at the attributes which
have been omitted from this example). Here's the \CE:

\begin{vcode}{ft}
track.lat>80.0&track.lat<90.0&track.lon<-50.0&track.lon>-60.0
\end{vcode}

If you requested the DataDDS using the constraint, the response would be:

\begin{vcode}{ft}
Content-Description: dods-data
Content-Type: text/plain
Server: Server: Apache/1.3.12 (Unix)  PHP/3.0.15 mod_perl/1.21
Date: Fri, 09 Feb 2001 18:54:55 GMT
Last-Modified: Mon, 05 Feb 2001 16:50:02 GMT<CRLF>
XDODS-Server: Friendly-neighborhood DAP implementation v/3.1.1

Dataset {
  Sequence {
    Float32 lat;
    Float32 lon;
    Sequence {
      Int16 depth;
      Float64 temp;
    } sounding;
  } track;
} temp4.dat;
Data:
<0x5A><track.lat><track.lon>
<0x5A><track.sounding.depth><track.sounding.temp>
<0x5A><track.sounding.depth><track.sounding.temp>
<0x5A><track.sounding.depth><track.sounding.temp>
<0x5A><track.sounding.depth><track.sounding.temp><0xA5>
<0x5A><track.lat><track.lon>
<0x5A><track.sounding.depth><track.sounding.temp>
<0x5A><track.sounding.depth><track.sounding.temp>
<0x5A><track.sounding.depth><track.sounding.temp><0xA5>
<0x5A><track.lat><track.lon>
<0x5A><track.sounding.depth><track.sounding.temp>
<0x5A><track.sounding.depth><track.sounding.temp>
<0x5A><track.sounding.depth><track.sounding.temp>
<0x5A><track.sounding.depth><track.sounding.temp>
<0x5A><track.sounding.depth><track.sounding.temp><0xA5><0xA5>
\end{vcode}

In this example, the constraint has selected three instances of the outer
\Sequence \lit{track}. For each instance of \lit{track}, there is a complete
inner \Sequence \lit{sounding} which, for this constraint, is sent in its
entirety.\footnote{You could write a different \CE that would choose only
values at a certain depth, {\it et cetera}.} Note that the end of sequence
marker following \lit{<track.sounding.temp>} is the marker for the end of the
inner \Sequence, called \lit{sounding}. The final \lit{A5}$_{16}$ is the end
of sequence marker for the outer \Sequence, \lit{track}.

\T\addcontentsline{toc}{section}{References}
\T\raggedright
\bibliography{../../../../boiler/dods-plus-standard}

\T\addcontentsline{toc}{section}{Authors}
\T\raggedright
\section*{Authors}
James Gallagher\\
OPeNDAP, Inc.\\
165 Dean Knauss Dr.\\
Narragansett, RI. 02882\\
Phone: 401.284.1304, email: jgallagher@opendap.org\\
\vspace{1.5em}

Nathan Potter\\
Oregon State University\\
Corvallis, OR 97331-4501\\
Phone: 541.737.2293, email: ndp@coas.oregonstate.edu\\
\vspace{1.5em}

Tom Sgouros\\
Manual Writing NA.\\
15 BostonNeck Road\\
Wickford RI 02852\\
Phone: 401.861.2831, email: tomfool@as220.org\\
\vspace{1.5em}

Steve Hankin\\
NOAA PMEL\\
7600 Sand Point Way NE\\
Seattle, WA 98115\\
Phone: 206.526.6080, email: Steven.C.Hankin@noaa.gov\\
\vspace{1.5em}

Glenn Flierl\\
MIT\\
77 Massachusetts Avenue\\
Cambridge, MA 02139-4307\\
Phone: 617.253.4692, email: glenn@lake.mit.edu\\
\T\appendix

\section{Notational Conventions and Generic Grammar}
\label{app:grammar}
\input{../../../../boiler/bnf-grammar.tex}

\section{Acronyms and Abbreviations}
The following acronyms are used in this text.
\begin{acronym}
\input{acronyms_dap_2_data_model.tex}
\end{acronym}

\section{Errata}

There are no errata for this document.

\begin{comment}

\section{Change log}

\begin{verbatim}
$Log: dap_2_data_model.tex,v $
Revision 1.36  2005/05/03 20:34:01  jimg
Updated

Revision 1.35  2005/04/27 01:19:54  jimg
Updated the change log as per Siri's request.

Revision 1.34  2005/04/20 18:16:45  jimg
Last round of changes before it goes to NASA.

Revision 1.33  2005/04/12 04:24:17  jimg
Added complete addresses for the authors.

Revision 1.32  2005/04/12 04:12:20  jimg
Updated date on change log.

Revision 1.31  2005/04/12 03:54:46  jimg
Minor fixes for latex.

Revision 1.30  2005/04/12 03:41:16  jimg
Added subsection for conditional requests. Added a comment about
encoding zero-length sequences.

Revision 1.29  2005/04/06 17:58:05  jimg
Changes from John Chamberlain: The Attribute grammar did not include
attribute vectors.

Revision 1.28  2005/04/06 03:05:57  jimg
Changes from the penultimate revision of the last draft.

Revision 1.27  2005/01/17 23:38:12  jimg
Updated version log.

Revision 1.26  2005/01/17 23:31:46  jimg
Changes from Benno Blumenthal (Columbia Univ.) and Ruixin Yang (GMU).

Revision 1.25  2004/12/20 20:44:54  jimg
Changes as per the TWG and solicited reviews.

Revision 1.24  2004/09/14 15:21:03  jimg
Changes suggested by John plus added the Change Explanation section. Adopted
the new RFC version numbering system.

Revision 1.23  2004/08/06 17:36:13  jimg
Added the Motivation subsection to the introduction.

Revision 1.22  2004/06/28 22:39:27  jimg
Two tiny fixes in the abstract: added two missing spaces after the comma in
'<text>,and'.

Revision 1.21  2004/06/28 22:19:48  jimg
Changes at the request of Allen Doyle. Reordered some of the front
matter and added Authors section.

Revision 1.20  2004/06/28 20:08:17  tomfool
changed author address

Revision 1.19  2004/06/08 21:21:22  jimg
Minor changes plus added the Errata appendix (new requirement; from Allan
Doyle <adoyle@intl-interfaces.com>).

Revision 1.18  2004/06/04 01:50:03  tomfool
proofs and edits

Revision 1.17  2004/06/04 00:48:53  tomfool
proofread, and prettied up for submission to NASA

Revision 1.16  2004/06/02 19:54:31  tomfool
put back into cvs, using nasa-ese style

Revision 1.15  2004/05/21 15:48:46  tom
fixed some references and labels

Revision 1.14  2004/05/21 15:29:34  tom
edits and additions on first half

Revision 1.13  2004/05/20 22:36:27  jimg
Check point. Editorial changes in Requests onward. Still working on the
Examples.

Revision 1.12  2004/05/20 04:41:59  tom
added an example section.  Still needs double checking

Revision 1.11  2004/05/19 17:47:32  jimg
Editorial changes up to the Requests section. I also rewrote parts of the
Names section and moved it from within Characterization of a Dataset to its
own section right before Requests.

Revision 1.10  2004/05/19 16:13:43  tom
added header and extensions to response body section

Revision 1.9  2004/05/18 23:30:13  jimg
I rewrote most of the subsection on attributes. I think we should be careful
to describe the required structure of the DAS response in that section and
not try to do that 'Attributes' section. At least that's what I think right
now...

Revision 1.8  2004/05/14 21:06:18  jimg
I've made some changes to the text in Requests and Responses. These are
mostly minor changes. I removed the section on Accept-Types.

Revision 1.7  2004/05/14 20:52:07  jimg
I've removed most of the DAP4 text that was commented out in an attempt to
simplify editing. I've changed text in the Introduction, Characterization of
a Dataset Constraint Expression sections.

Revision 1.6  2004/05/14 02:05:01  tom
a bit more progress

Revision 1.5  2004/05/14 00:04:36  tom
some fixes to the requests and responses section -- more to be done
but here's progress.

Revision 1.4  2004/05/13 22:21:38  jimg
Reworked the Introduction, which now contains most of the text from the
Client/Server Interaction section (which has been removed). The
Characterization of a Dataset section has been reworked and the Variables and
Attributes sections have been moved into it as subsections. I removed the
discussion of the DAS, ..., from there in favor of concentrating that in the
Overall Operation subsection of the Introduction. We should provide the
normative description of the Responses in the Requests and Responses
sections. Lots of text commented out still.

Revision 1.3  2004/05/12 23:38:06  jimg
This is the initial version of the DAP2 incorporating those parts of the DAP4
variable and attribute descriptions which are relevant.

Revision 1.2  2004/05/12 22:37:20  jimg
Changes: 'dataset' --> 'data source', The title, document class, et c., are
now like those used for the DAP 4 data model document and the ASCII, ...,
sections have been removed. I've retained the Help and Version responses
because I think these should be part of the standard.
Plan: Add a section that describes extensibility and points to the ASCII
'note.' This ties in with the Help response, which is a kind of poor-man's
discovery.

Revision 1.1  2004/05/12 14:14:22  tom
taken from ../dap_rfc.tex v1.22

\end{verbatim}
\end{comment}

\end{document}
